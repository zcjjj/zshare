<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>面向 Agent 的 LLM 推理全栈优化</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 浅色主题配色 */
            --bg-dark: #f8fafc;       /* Slate 50 */
            --bg-panel: #ffffff;      /* White */
            --bg-sidebar: #f1f5f9;    /* Slate 100 */
            
            --text-primary: #0f172a;  /* Slate 900 */
            --text-secondary: #475569;/* Slate 600 */
            --text-code: #334155;     /* Slate 700 */

            /* 功能色系 */
            --c-gateway: #7c3aed;     /* Violet 600 */
            --c-prefill: #2563eb;     /* Blue 600 */
            --c-decode: #059669;      /* Emerald 600 */
            --c-infra: #d97706;       /* Amber 600 - Storage */
            --c-network: #6366f1;     /* Indigo 500 - Network */
            --c-danger: #dc2626;      /* Red 600 */
            --c-line: #94a3b8;        /* Slate 400 */
            
            --border: #cbd5e1;        /* Slate 300 */
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            width: 100vw;
            display: flex;
            overflow: hidden;
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 260px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem 1rem;
            flex-shrink: 0;
            z-index: 10;
        }

        .brand {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 0.5rem;
        }

        .nav-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .nav-list::-webkit-scrollbar { width: 4px; }
        .nav-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 2px; }

        .nav-group-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin: 15px 0 5px 10px;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .nav-item {
            padding: 10px 12px;
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(0,0,0,0.05);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: #e2e8f0;
            color: var(--text-primary);
            border-left-color: currentColor; 
        }

        /* --- Main Stage --- */
        .main-stage {
            flex: 1;
            padding: 2rem 4rem;
            display: flex;
            flex-direction: column;
            position: relative;
            background: radial-gradient(circle at top right, #f1f5f9 0%, #f8fafc 70%);
        }

        .slide-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            animation: fadeUp 0.3s ease-out;
            height: 100%;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-header {
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border);
            padding-bottom: 1rem;
            flex-shrink: 0;
        }
        
        .slide-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 1rem;
            letter-spacing: -0.5px;
        }

        .slide-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 5px;
            font-weight: 500;
        }

        /* --- Content Layout --- */
        .content-split {
            display: flex;
            flex-direction: column;
            height: 100%;
            gap: 1.5rem;
        }

        /* Top: Diagram Area (Hardcore) */
        .diagram-area {
            flex: 5;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 250px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.02);
            background-image: linear-gradient(#e2e8f0 1px, transparent 1px), linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .diagram-badge {
            position: absolute;
            top: 10px; left: 10px;
            font-size: 0.7rem;
            padding: 4px 8px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 4px;
            color: var(--text-secondary);
            font-family: monospace;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            z-index: 10;
        }

        svg text {
            font-family: 'JetBrains Mono', monospace;
        }

        /* Bottom: Details Grid */
        .details-grid {
            flex: 4;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            min-height: 0;
        }

        .card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            transition: all 0.2s;
            box-shadow: var(--shadow);
        }
        
        .card:hover { 
            transform: translateY(-2px); 
            border-color: #94a3b8;
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 800;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px dashed var(--border);
            padding-bottom: 8px;
        }
        
        .card-body {
            font-size: 0.85rem;
            line-height: 1.6;
            color: #334155;
            overflow-y: auto;
            flex: 1;
        }

        .card.challenge-card {
            background-color: #fff1f2;
            border-color: #fecaca;
        }
        .challenge-card .card-title {
            color: var(--c-danger);
            border-bottom-color: #fecaca;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            color: var(--c-prefill);
            font-size: 0.9em;
            border: 1px solid #e2e8f0;
        }

        /* --- Lifecycle Map --- */
        .lc-container { display: flex; flex-direction: column; align-items: center; padding: 20px 0; gap: 15px; width: 100%; }
        .lc-step { display: flex; align-items: center; gap: 30px; width: 100%; max-width: 800px; cursor: default; transition: transform 0.2s; }
        .lc-icon-box { width: 70px; height: 70px; background: var(--bg-panel); border: 2px solid; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; box-shadow: var(--shadow); flex-shrink: 0; z-index: 2; }
        .lc-line-connect { position: absolute; left: 39px; top: -30px; bottom: -30px; width: 2px; background: #cbd5e1; z-index: 0; border-left: 2px dashed #cbd5e1; }
        .lc-card { flex: 1; background: var(--bg-panel); border: 1px solid var(--border); border-radius: var(--radius); padding: 1rem; box-shadow: var(--shadow); position: relative; overflow: hidden; display:flex; flex-direction:column; justify-content:center;}
        .lc-bg-icon { position: absolute; right: -10px; bottom: -10px; font-size: 5rem; opacity: 0.05; z-index: 0; }
        .lc-title { font-weight: 800; font-size: 1rem; margin-bottom: 5px; z-index: 1; position: relative; }
        .lc-desc { font-size: 0.8rem; color: var(--text-secondary); z-index: 1; position: relative; }
        .lc-tags { display: flex; gap: 6px; margin-top: 5px; flex-wrap: wrap; }
        .lc-tag { font-size: 0.7rem; padding: 3px 8px; border-radius: 4px; background: #f1f5f9; color: var(--text-secondary); border: 1px solid #e2e8f0; }

        /* --- Page Number & PDF Button --- */
        .page-number {
            position: absolute;
            bottom: 20px;
            right: 30px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            color: var(--text-secondary);
            opacity: 0.6;
            pointer-events: none;
        }

        .pdf-btn-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 4px;
            animation: fadeIn 0.5s;
        }
        .pdf-btn {
            border: none;
            background: transparent;
            cursor: pointer;
            padding: 6px 12px;
            font-size: 0.85rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
            border-right: 1px solid #eee;
        }
        .pdf-btn:hover { background-color: #f8fafc; border-radius: 4px;}
        .pdf-close {
            padding: 6px 10px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
        }
        .pdf-close:hover { color: var(--c-danger); }

        /* --- PRINT STYLES (PDF Export) --- */
        /* Only visible during printing */
        #printContainer {
            display: none;
        }

        @media print {
            /* Hide UI elements */
            .sidebar, .pdf-btn-container, #slideContainer, #pageNum { 
                display: none !important; 
            }
            
            /* Show Print Container */
            #printContainer {
                display: block !important;
                background-color: white;
            }

            /* Reset body for print */
            body {
                background-color: white;
                height: auto;
                width: auto;
                overflow: visible;
                display: block;
            }
            
            .main-stage {
                padding: 0;
                background: white;
                height: auto;
                overflow: visible;
                display: block;
            }

            /* Page break logic */
            .print-page {
                break-after: page;
                page-break-after: always;
                height: 100vh; /* Force full page height */
                width: 100%;
                padding: 40px; /* Add margin for print */
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
            }
            
            /* Avoid breaking inside cards */
            .card {
                break-inside: avoid;
            }
            
            /* Ensure diagrams scale */
            svg {
                max-width: 100%;
                height: auto;
            }
        }

    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand">
            <i class="fa-solid fa-server"></i> AgentInfra
        </div>
        <div class="nav-list" id="navList">
            <!-- JS Generated -->
        </div>
    </aside>

    <main class="main-stage">
        <!-- PDF Button -->
        <div id="pdfBtn" class="pdf-btn-container">
            <button class="pdf-btn" onclick="window.printAllSlides()">
                <i class="fa-solid fa-file-pdf"></i> 转成 PDF (全量)
            </button>
            <div class="pdf-close" onclick="document.getElementById('pdfBtn').style.display='none'">
                <i class="fa-solid fa-times"></i>
            </div>
        </div>

        <!-- Interactive Slide Container -->
        <div id="slideContainer" class="slide-container"></div>
        
        <!-- Hidden Container for Printing All Slides -->
        <div id="printContainer"></div>

        <!-- Page Number -->
        <div id="pageNum" class="page-number"></div>
    </main>

    <script>
    (function() {
        const C = {
            gateway: '#7c3aed',
            prefill: '#2563eb',
            decode: '#059669',
            infra: '#d97706',
            network: '#6366f1',
            text: '#0f172a',
            sub: '#64748b',
            line: '#94a3b8',
            bg: '#ffffff'
        };

        // Common SVG Definitions
        const defs = `
            <defs>
                <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="${C.sub}" />
                </marker>
                <marker id="arrow-gateway" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="${C.gateway}" />
                </marker>
                <marker id="arrow-prefill" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="${C.prefill}" />
                </marker>
                <filter id="dropShadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.15"/>
                </filter>
            </defs>
        `;

        const slides = [
            // --- HOME ---
            {
                id: 'home',
                group: '简介',
                title: 'Agent LLM 推理全栈优化',
                render: () => `
                    <div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
                        <div style="font-size: 6rem; margin-bottom: 2rem; background: linear-gradient(135deg, ${C.prefill}, ${C.gateway}); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            <i class="fa-solid fa-layer-group"></i>
                        </div>
                        <h1 style="font-size: 3.5rem; font-weight: 900; margin-bottom: 1.5rem; color: ${C.text};">
                            面向 Agent 的 LLM 推理全栈优化
                        </h1>
                        
                    </div>
                `
            },

            // --- INTRO: BACKGROUND (MERGED) ---
            {
                id: 'background',
                group: '简介',
                title: '背景：推理爆发与 Agent 负载特征',
                meta: 'Context & Trends',
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">市场与负载全景图</div>
                            <svg width="800" height="280" viewBox="0 0 800 280">
                                ${defs}
                                
                                <!-- 1. The Flip (Left) -->
                                <g transform="translate(30, 30)">
                                    <text x="60" y="-10" text-anchor="middle" font-weight="bold" font-size="12">1. 算力结构翻转</text>
                                    
                                    <!-- 2023 -->
                                    <rect x="20" y="20" width="30" height="120" fill="#e2e8f0"/>
                                    <rect x="20" y="44" width="30" height="96" fill="${C.gateway}" opacity="0.6"/> 
                                    <rect x="20" y="20" width="30" height="24" fill="${C.decode}"/>
                                    <text x="35" y="155" text-anchor="middle" font-size="10">2023</text>
                                    
                                    <!-- Arrow -->
                                    <path d="M 60 80 L 80 80" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>
                                    
                                    <!-- 2026 -->
                                    <rect x="90" y="20" width="30" height="120" fill="#e2e8f0"/>
                                    <rect x="90" y="116" width="30" height="24" fill="${C.gateway}" opacity="0.6"/>
                                    <rect x="90" y="20" width="30" height="96" fill="${C.decode}"/>
                                    <text x="105" y="155" text-anchor="middle" font-size="10">2026</text>
                                    
                                    <text x="70" y="180" text-anchor="middle" font-size="9" fill="${C.sub}">推理 > 训练</text>
                                </g>

                                <line x1="160" y1="20" x2="160" y2="220" stroke="${C.line}" stroke-dasharray="4"/>

                                <!-- 2. The Multiplier (Middle) -->
                                <g transform="translate(200, 30)">
                                    <text x="120" y="-10" text-anchor="middle" font-weight="bold" font-size="12">2. Agent 倍增效应</text>
                                    
                                    <circle cx="20" cy="80" r="12" fill="#f1f5f9" stroke="${C.text}"/>
                                    <text x="20" y="110" text-anchor="middle" font-size="9">User</text>
                                    
                                    <path d="M 40 80 L 70 80" stroke="${C.text}" stroke-width="2" marker-end="url(#arrow)"/>
                                    
                                    <!-- Agent Box -->
                                    <rect x="80" y="20" width="140" height="120" rx="8" fill="#f0fdf4" stroke="${C.decode}" stroke-width="2"/>
                                    <text x="150" y="40" text-anchor="middle" font-weight="bold" font-size="10" fill="${C.decode}">ReAct Loop</text>
                                    
                                    <rect x="100" y="55" width="100" height="20" fill="#fff" stroke="${C.decode}"/><text x="150" y="69" text-anchor="middle" font-size="9">Thinking (CoT)</text>
                                    <rect x="100" y="80" width="100" height="20" fill="#fff" stroke="${C.infra}"/><text x="150" y="94" text-anchor="middle" font-size="9">Tool Calls</text>
                                    <rect x="100" y="105" width="100" height="20" fill="#fff" stroke="${C.decode}"/><text x="150" y="119" text-anchor="middle" font-size="9">Response</text>
                                    
                                    <text x="150" y="160" text-anchor="middle" font-size="11" font-weight="bold" fill="${C.decode}">x100 Compute</text>
                                </g>

                                <line x1="470" y1="20" x2="470" y2="220" stroke="${C.line}" stroke-dasharray="4"/>

                                <!-- 3. Workload Shift (Right) - Enhanced -->
                                <g transform="translate(500, 30)">
                                    <text x="120" y="-10" text-anchor="middle" font-weight="bold" font-size="12">3. 负载特征变化 (瓶颈转移)</text>
                                    
                                    <!-- Chatbot: Decode Dominant -->
                                    <g transform="translate(20, 20)">
                                        <!-- Prefill (Small) -->
                                        <rect x="10" y="110" width="40" height="10" fill="${C.prefill}" stroke="${C.text}" stroke-width="1"/>
                                        <text x="30" y="118" text-anchor="middle" font-size="8" fill="#fff">Pre</text>
                                        
                                        <!-- Decode (Tall) -->
                                        <rect x="10" y="10" width="40" height="95" fill="${C.decode}" opacity="0.8"/>
                                        <text x="30" y="60" text-anchor="middle" font-size="9" fill="#fff" writing-mode="tb">Decode</text>
                                        
                                        <text x="30" y="135" text-anchor="middle" font-size="10" font-weight="bold">Chatbot</text>
                                        <text x="30" y="150" text-anchor="middle" font-size="9" fill="${C.sub}">Memory Bound</text>
                                        <text x="30" y="162" text-anchor="middle" font-size="8" fill="${C.sub}">(搬运权重)</text>
                                    </g>
                                    
                                    <!-- Arrow -->
                                    <path d="M 90 70 L 120 70" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>
                                    
                                    <!-- Agent: Prefill Dominant -->
                                    <g transform="translate(140, 20)">
                                        <!-- Prefill (Huge Area) -->
                                        <rect x="10" y="50" width="80" height="70" fill="${C.prefill}" stroke="${C.text}" stroke-width="1"/>
                                        <text x="50" y="80" text-anchor="middle" font-size="10" font-weight="bold" fill="#fff">Prefill (Huge)</text>
                                        <text x="50" y="95" text-anchor="middle" font-size="8" fill="#fff">System + RAG</text>
                                        
                                        <!-- Decode (Short) -->
                                        <rect x="30" y="10" width="40" height="35" fill="${C.decode}" opacity="0.8"/>
                                        <text x="50" y="30" text-anchor="middle" font-size="9" fill="#fff">Dec</text>
                                        
                                        <text x="50" y="135" text-anchor="middle" font-size="10" font-weight="bold" fill="${C.prefill}">Agent</text>
                                        <text x="50" y="150" text-anchor="middle" font-size="9" fill="${C.sub}">Compute Bound</text>
                                        <text x="50" y="162" text-anchor="middle" font-size="8" fill="${C.sub}">(矩阵运算)</text>
                                    </g>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card">
                                <div class="card-title" style="color:${C.gateway}"><i class="fa-solid fa-chart-pie"></i> 经济规律 (One-to-Many)</div>
                                <div class="card-body">
                                    <b>训练是"印书"，推理是"卖书"。</b><br>
                                    模型训练是一次性投入，而推理服务需 7x24 响应。NVIDIA 数据显示，推理收入占比已达 40% (2024)，预计 2026 年将达 80%。
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.decode}"><i class="fa-solid fa-brain"></i> System 2 思考</div>
                                <div class="card-body">
                                    以 OpenAI o1 为代表，模型通过<b>增加推理时的计算量 (Test-time Compute)</b> 来换取更高智能。Agent 的多轮 Tool Use 和 CoT 使得单次交互的计算量激增 10-100 倍。
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.prefill}"><i class="fa-solid fa-weight-hanging"></i> 负载重心转移</div>
                                <div class="card-body">
                                    <b>传统 Chat:</b> 瓶颈在显存带宽 (Memory Bound)，因为主要是逐字生成。<br>
                                    <b>Agent:</b> 巨型 Context 导致 <b>Prefill (预填充)</b> 占比激增。Prefill 是矩阵乘法密集型，瓶颈转向了 <b>GPU 算力 (Compute Bound)</b>。
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // --- LIFECYCLE ---
            {
                id: 'lifecycle',
                group: '简介',
                title: '全生命周期优化地图 (End-to-End Flow)',
                meta: 'Request Processing Pipeline',
                render: () => `
                    <div style="height:100%; overflow-y:auto; padding:20px;">
                        <div class="lc-container">
                            <!-- L1 -->
                            <div class="lc-step">
                                <div class="lc-icon-box" style="border-color:${C.gateway}; color:${C.gateway};">
                                    <i class="fa-solid fa-filter"></i>
                                </div>
                                <div class="lc-card" style="border-left: 5px solid ${C.gateway};">
                                    <i class="fa-solid fa-network-wired lc-bg-icon"></i>
                                    <div class="lc-title" style="color:${C.gateway}">L1. Gateway 网关层</div>
                                    <div class="lc-desc">流量意图识别、智能路由分发与 Prompt 压缩</div>
                                </div>
                            </div>
                            <!-- Connector -->
                            <div style="height:15px; border-left:2px dashed ${C.line}; margin-left:-40px;"></div>

                            <!-- L2 -->
                            <div class="lc-step">
                                <div class="lc-icon-box" style="border-color:${C.prefill}; color:${C.prefill};">
                                    <i class="fa-solid fa-memory"></i>
                                </div>
                                <div class="lc-card" style="border-left: 5px solid ${C.prefill};">
                                    <i class="fa-solid fa-microchip lc-bg-icon"></i>
                                    <div class="lc-title" style="color:${C.prefill}">L2. Prefill 预填充层 (计算密集)</div>
                                    <div class="lc-desc">长上下文加载、KV Cache 填充、分块调度</div>
                                </div>
                            </div>
                            <!-- Connector -->
                            <div style="height:15px; border-left:2px dashed ${C.line}; margin-left:-40px;"></div>

                            <!-- L3 -->
                            <div class="lc-step">
                                <div class="lc-icon-box" style="border-color:${C.decode}; color:${C.decode};">
                                    <i class="fa-solid fa-bolt"></i>
                                </div>
                                <div class="lc-card" style="border-left: 5px solid ${C.decode};">
                                    <i class="fa-solid fa-pen-nib lc-bg-icon"></i>
                                    <div class="lc-title" style="color:${C.decode}">L3. Decode 解码层 (访存密集)</div>
                                    <div class="lc-desc">Token 逐字生成、采样策略、投机验证</div>
                                </div>
                            </div>
                            <!-- Connector -->
                            <div style="height:15px; border-left:2px dashed ${C.line}; margin-left:-40px;"></div>

                            <!-- L4 Storage -->
                            <div class="lc-step">
                                <div class="lc-icon-box" style="border-color:${C.infra}; color:${C.infra};">
                                    <i class="fa-solid fa-database"></i>
                                </div>
                                <div class="lc-card" style="border-left: 5px solid ${C.infra};">
                                    <i class="fa-solid fa-hard-drive lc-bg-icon"></i>
                                    <div class="lc-title" style="color:${C.infra}">L4. Storage 存储层</div>
                                    <div class="lc-desc">虚拟显存管理 (VM)、分级存储卸载 (Offloading)</div>
                                </div>
                            </div>
                            <!-- Connector -->
                            <div style="height:15px; border-left:2px dashed ${C.line}; margin-left:-40px;"></div>

                            <!-- L5 Network -->
                            <div class="lc-step">
                                <div class="lc-icon-box" style="border-color:${C.network}; color:${C.network};">
                                    <i class="fa-solid fa-circle-nodes"></i>
                                </div>
                                <div class="lc-card" style="border-left: 5px solid ${C.network};">
                                    <i class="fa-solid fa-share-nodes lc-bg-icon"></i>
                                    <div class="lc-title" style="color:${C.network}">L5. Network 网络层</div>
                                    <div class="lc-desc">RDMA 互联、NVLink、高速 KV 传输</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // --- GATEWAY: SMART ROUTING ---
            {
                id: 'smart-routing',
                group: '1. 网关层',
                title: 'Smart Routing 智能路由',
                meta: '基于意图的大小模型分流',
                color: C.gateway,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">逻辑拓扑 (Logical Topology)</div>
                            <svg width="800" height="280" viewBox="0 0 800 280">
                                ${defs}
                                <!-- Input -->
                                <rect x="50" y="110" width="100" height="60" rx="4" fill="#fff" stroke="${C.text}" stroke-dasharray="4" />
                                <text x="100" y="135" text-anchor="middle" font-size="12" fill="${C.text}">用户请求</text>
                                <text x="100" y="150" text-anchor="middle" font-size="10" fill="${C.sub}">(Query)</text>
                                
                                <line x1="150" y1="140" x2="200" y2="140" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)" />

                                <!-- Classifier -->
                                <polygon points="250,100 300,140 250,180 200,140" fill="#f3e8ff" stroke="${C.gateway}" stroke-width="2" filter="url(#dropShadow)"/>
                                <text x="250" y="135" text-anchor="middle" font-size="11" font-weight="bold" fill="${C.gateway}">BERT</text>
                                <text x="250" y="150" text-anchor="middle" font-size="9" fill="${C.gateway}">分类器</text>

                                <!-- Paths -->
                                <path d="M300 140 L340 140 L340 80 L380 80" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)" fill="none" />
                                <text x="345" y="70" font-size="10" fill="${C.sub}">简单 (分 > 0.8)</text>

                                <path d="M300 140 L340 140 L340 200 L380 200" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)" fill="none" />
                                <text x="345" y="190" font-size="10" fill="${C.sub}">复杂推理</text>

                                <!-- Models -->
                                <rect x="380" y="50" width="140" height="60" rx="4" fill="#fff" stroke="${C.decode}" stroke-width="2" filter="url(#dropShadow)"/>
                                <text x="450" y="75" text-anchor="middle" font-weight="bold" fill="${C.decode}">小模型</text>
                                <text x="450" y="90" text-anchor="middle" font-size="10" fill="${C.sub}">Llama-3-8B</text>

                                <rect x="380" y="170" width="140" height="60" rx="4" fill="#fff" stroke="${C.gateway}" stroke-width="2" filter="url(#dropShadow)"/>
                                <text x="450" y="195" text-anchor="middle" font-weight="bold" fill="${C.gateway}">大模型</text>
                                <text x="450" y="210" text-anchor="middle" font-size="10" fill="${C.sub}">GPT-4 / 70B</text>

                                <!-- Fallback -->
                                <path d="M520 80 L550 80 L550 200 L530 200" stroke="${C.danger}" stroke-width="1.5" stroke-dasharray="4" marker-end="url(#arrow)" fill="none" />
                                <text x="560" y="140" font-size="10" fill="${C.danger}" writing-mode="tb">降级 (置信度低)</text>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card">
                                <div class="card-title" style="color:${C.gateway}"><i class="fa-solid fa-book"></i> 原理 (Principle)</div>
                                <div class="card-body">
                                    在网关层部署轻量级模型作为前置分类器。通过分析 Prompt 的语义复杂度、意图类型（如闲聊 vs 编码），动态将流量分发至不同规模的推理模型，实现成本与效果的平衡。
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.gateway}"><i class="fa-solid fa-desktop"></i> 实例 (Example)</div>
                                <div class="card-body">
                                    <ul>
                                        <li><b>Easy:</b> "将 '2024-01-01' 转为时间戳" -> 路由至 8B 模型。</li>
                                        <li><b>Hard:</b> "分析这 20 份财报的潜在风险" -> 路由至 70B+ 模型。</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title"><i class="fa-solid fa-triangle-exclamation"></i> 挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol style="padding-left:20px; margin:0;">
                                        <li><b>路由延迟：</b>分类器必须极快（<5ms），否则会抵消小模型的速度优势。</li>
                                        <li><b>准确性权衡：</b>如果误将复杂任务分给小模型，会导致用户体验崩塌。必须设计<b>自动降级 (Fallback)</b> 机制。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // --- GATEWAY: AFFINITY ---
            {
                id: 'affinity',
                group: '1. 网关层',
                title: 'Cache Affinity 缓存亲和性',
                meta: '用户粘性路由',
                color: C.gateway,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">UML 部署视图 (Deployment View)</div>
                            <svg width="800" height="280" viewBox="0 0 800 280">
                                ${defs}
                                <!-- Users -->
                                <circle cx="60" cy="60" r="20" fill="#f3e8ff" stroke="${C.gateway}" stroke-width="2"/>
                                <text x="60" y="65" text-anchor="middle" font-size="12" font-weight="bold" fill="${C.gateway}">U1</text>
                                <text x="60" y="100" text-anchor="middle" font-size="10" fill="${C.sub}">会话 A</text>

                                <circle cx="60" cy="200" r="20" fill="#fff" stroke="${C.sub}" stroke-width="2"/>
                                <text x="60" y="205" text-anchor="middle" font-size="12" font-weight="bold" fill="${C.sub}">U2</text>
                                <text x="60" y="240" text-anchor="middle" font-size="10" fill="${C.sub}">会话 B</text>

                                <!-- LB -->
                                <rect x="200" y="40" width="120" height="200" rx="8" fill="#fff" stroke="${C.text}" stroke-width="2" filter="url(#dropShadow)"/>
                                <text x="260" y="70" text-anchor="middle" font-weight="bold">负载均衡 (LB)</text>
                                <line x1="220" y1="90" x2="300" y2="90" stroke="${C.line}" stroke-width="1"/>
                                <text x="260" y="120" text-anchor="middle" font-size="11" fill="${C.gateway}">Map<ID, Node></text>
                                <text x="260" y="140" text-anchor="middle" font-size="10" fill="${C.sub}" font-family="monospace">Hash(User_ID)</text>

                                <!-- Connections In -->
                                <path d="M90 60 L200 100" stroke="${C.gateway}" stroke-width="2" stroke-dasharray="4" marker-end="url(#arrow-gateway)"/>
                                <path d="M90 200 L200 160" stroke="${C.sub}" stroke-width="2" marker-end="url(#arrow)"/>

                                <!-- Nodes -->
                                <g transform="translate(450, 40)">
                                    <rect x="0" y="0" width="160" height="80" rx="4" fill="#f3e8ff" stroke="${C.gateway}" stroke-width="2"/>
                                    <text x="10" y="20" font-weight="bold" fill="${C.gateway}" font-size="12">Worker #1</text>
                                    <rect x="10" y="35" width="140" height="35" fill="#fff" stroke="${C.gateway}" stroke-dasharray="2"/>
                                    <text x="80" y="55" text-anchor="middle" font-size="10" fill="${C.sub}">KV Cache: U1</text>
                                </g>

                                <g transform="translate(450, 160)">
                                    <rect x="0" y="0" width="160" height="80" rx="4" fill="#fff" stroke="${C.sub}" stroke-width="2"/>
                                    <text x="10" y="20" font-weight="bold" fill="${C.sub}" font-size="12">Worker #2</text>
                                    <rect x="10" y="35" width="140" height="35" fill="#fff" stroke="${C.sub}" stroke-dasharray="2"/>
                                    <text x="80" y="55" text-anchor="middle" font-size="10" fill="${C.sub}">KV Cache: U2</text>
                                </g>

                                <!-- Connections Out -->
                                <path d="M320 100 L450 80" stroke="${C.gateway}" stroke-width="2" marker-end="url(#arrow-gateway)"/>
                                <text x="385" y="85" text-anchor="middle" font-size="10" fill="${C.gateway}" font-weight="bold">粘性连接</text>
                                
                                <path d="M320 160 L450 200" stroke="${C.sub}" stroke-width="2" marker-end="url(#arrow)"/>

                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card">
                                <div class="card-title" style="color:${C.gateway}"><i class="fa-solid fa-book"></i> 原理 (Principle)</div>
                                <div class="card-body">
                                    在云服务多实例场景中，负载均衡器 (LB) 维护 <b>Session Sticky (会话粘性)</b> 策略。基于 UserID 或 ConversationID 进行哈希路由，确保同一用户的连续请求总是被分发到同一台 Worker 实例，从而命中本地 KV Cache。
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.gateway}"><i class="fa-solid fa-desktop"></i> 实例 (Example)</div>
                                <div class="card-body">
                                    <b>多轮对话场景：</b>
                                    <ul>
                                        <li><b>Round 1:</b> 路由到 Worker-A，计算并缓存 Context。</li>
                                        <li><b>Round 2:</b> 再次路由到 Worker-A。直接复用 Round 1 的 KV Cache，仅需计算新增 Query，首字延迟降低 80%。</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title"><i class="fa-solid fa-triangle-exclamation"></i> 挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol style="padding-left:20px; margin:0;">
                                        <li><b>负载倾斜 (Load Skew)：</b>若某用户是"话痨"（高频长文），会导致对应 Worker 过载。需设计<b>"Affinity + Least Loaded"</b> 混合策略（如：负载 > 80% 时打破亲和性）。</li>
                                        <li><b>扩缩容失效：</b>Worker 扩容时，Hash 环改变导致缓存大面积失效。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // --- GATEWAY: COMPRESSION ---
            {
                id: 'compression',
                group: '1. 网关层',
                title: 'Prompt Compression 提示词压缩',
                meta: '选择性上下文压缩',
                color: C.gateway,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">Token Importance Scoring & Pruning</div>
                            <svg width="800" height="280" viewBox="0 0 800 280">
                                ${defs}
                                <!-- Step 1: Input -->
                                <g transform="translate(50, 120)">
                                    <text x="0" y="-40" font-weight="bold" font-size="11">1. 原始 Prompt</text>
                                    <g>
                                        <rect x="0" y="0" width="20" height="20" fill="#e2e8f0" stroke="#94a3b8"/>
                                        <text x="10" y="14" text-anchor="middle" font-size="8">The</text>
                                        
                                        <rect x="25" y="0" width="30" height="20" fill="#e2e8f0" stroke="#94a3b8"/>
                                        <text x="40" y="14" text-anchor="middle" font-size="8">quick</text>
                                        
                                        <rect x="60" y="0" width="30" height="20" fill="#e2e8f0" stroke="#94a3b8"/>
                                        <text x="75" y="14" text-anchor="middle" font-size="8">brown</text>
                                        
                                        <rect x="95" y="0" width="25" height="20" fill="#e2e8f0" stroke="#94a3b8"/>
                                        <text x="107" y="14" text-anchor="middle" font-size="8">fox</text>
                                    </g>
                                </g>

                                <line x1="140" y1="130" x2="180" y2="130" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>

                                <!-- Step 2: Scoring -->
                                <g transform="translate(190, 80)">
                                    <text x="0" y="0" font-weight="bold" font-size="11">2. 重要性评分 (Perplexity/Attn)</text>
                                    
                                    <!-- The (Low) -->
                                    <rect x="0" y="40" width="20" height="20" fill="#e2e8f0" opacity="0.3"/>
                                    <rect x="0" y="35" width="20" height="5" fill="${C.sub}"/>
                                    <text x="10" y="55" text-anchor="middle" font-size="8" fill="${C.sub}">The</text>

                                    <!-- quick (High) -->
                                    <rect x="25" y="40" width="30" height="20" fill="#f3e8ff"/>
                                    <rect x="25" y="10" width="30" height="30" fill="${C.gateway}"/>
                                    <text x="40" y="55" text-anchor="middle" font-size="8" font-weight="bold">quick</text>

                                    <!-- brown (Med) -->
                                    <rect x="60" y="40" width="30" height="20" fill="#f3e8ff"/>
                                    <rect x="60" y="20" width="30" height="20" fill="${C.gateway}" opacity="0.8"/>
                                    <text x="75" y="55" text-anchor="middle" font-size="8" font-weight="bold">brown</text>
                                    
                                    <!-- fox (High) -->
                                    <rect x="95" y="40" width="25" height="20" fill="#f3e8ff"/>
                                    <rect x="95" y="10" width="25" height="30" fill="${C.gateway}"/>
                                    <text x="107" y="55" text-anchor="middle" font-size="8" font-weight="bold">fox</text>
                                    
                                    <!-- Threshold Line -->
                                    <line x1="-10" y1="30" x2="140" y2="30" stroke="${C.danger}" stroke-dasharray="4"/>
                                    <text x="145" y="33" font-size="9" fill="${C.danger}">阈值</text>
                                </g>

                                <line x1="360" y1="130" x2="400" y2="130" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>

                                <!-- Step 3: Result -->
                                <g transform="translate(410, 120)">
                                    <text x="0" y="-40" font-weight="bold" font-size="11">3. 压缩结果 (Pruned)</text>
                                    <g>
                                        <rect x="0" y="0" width="30" height="20" fill="#f3e8ff" stroke="${C.gateway}"/>
                                        <text x="15" y="14" text-anchor="middle" font-size="8">quick</text>
                                        
                                        <rect x="35" y="0" width="30" height="20" fill="#f3e8ff" stroke="${C.gateway}"/>
                                        <text x="50" y="14" text-anchor="middle" font-size="8">brown</text>
                                        
                                        <rect x="70" y="0" width="25" height="20" fill="#f3e8ff" stroke="${C.gateway}"/>
                                        <text x="82" y="14" text-anchor="middle" font-size="8">fox</text>
                                    </g>
                                </g>
                                
                                <!-- Info Box -->
                                <g transform="translate(600, 100)">
                                    <rect x="0" y="0" width="140" height="60" rx="4" fill="#f0fdf4" stroke="${C.decode}"/>
                                    <text x="70" y="25" text-anchor="middle" font-weight="bold" fill="${C.decode}" font-size="12">3倍 提速</text>
                                    <text x="70" y="45" text-anchor="middle" fill="${C.decode}" font-size="10">PPL Loss < 1%</text>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card">
                                <div class="card-title" style="color:${C.gateway}"><i class="fa-solid fa-book"></i> 原理 (Principle)</div>
                                <div class="card-body">
                                    基于信息论。使用一个小模型（如 LLMLingua）计算 Prompt 中每个 Token 的 <b>困惑度 (Perplexity)</b> 或 <b>注意力权重 (Self-Attention)</b>。
                                    保留携带核心语义的高分 Token，剪枝掉停用词、修饰语等低分 Token。
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.gateway}"><i class="fa-solid fa-desktop"></i> 实例 (Example)</div>
                                <div class="card-body">
                                    <b>RAG 场景：</b> 检索回来 10 篇文档，总计 15k Tokens。
                                    <br><b>压缩：</b> 去除冗余的页眉页脚、客套话、无关段落。
                                    <br><b>结果：</b> 变为 6k Tokens，直接塞入 8k 上下文窗口，无需分片，且推理速度提升 2.5 倍。
                                </div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title"><i class="fa-solid fa-triangle-exclamation"></i> 挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol style="padding-left:20px; margin:0;">
                                        <li><b>关键信息丢失：</b>可能误删 "not" 等改变句义的词。需要引入 <b>Coarse-to-Fine (粗粒度到细粒度)</b> 的保护机制。</li>
                                        <li><b>额外延迟：</b>压缩本身也是一次推理。只适用于 <b>Prefill 耗时 >> 压缩耗时</b> 的超长文本场景。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // --- PREFILL: PD SEP ---
            {
                id: 'pd-sep',
                group: '2. 预填充层',
                title: 'PD Disaggregation (分离架构)',
                meta: 'Prefill-Decode 分离',
                color: C.prefill,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">分离层级视图 (Layered Architecture)</div>
                            <svg width="800" height="280" viewBox="0 0 800 280">
                                ${defs}
                                
                                <!-- 1. User/Router Layer (Top) -->
                                <g transform="translate(50, 30)">
                                    <rect x="0" y="0" width="700" height="40" rx="8" fill="#f3e8ff" stroke="${C.gateway}" stroke-width="2"/>
                                    <text x="350" y="25" text-anchor="middle" font-weight="bold" fill="${C.gateway}">用户请求入口层 (Gateway / Router)</text>
                                </g>

                                <!-- Arrows -->
                                <line x1="200" y1="70" x2="200" y2="90" stroke="${C.gateway}" stroke-width="2" marker-end="url(#arrow-gateway)"/>
                                <line x1="600" y1="70" x2="600" y2="90" stroke="${C.gateway}" stroke-width="2" marker-end="url(#arrow-gateway)"/>

                                <!-- 2. Compute Layer (Middle) -->
                                <g transform="translate(50, 90)">
                                    <!-- Prefill Cluster -->
                                    <rect x="0" y="0" width="300" height="70" rx="8" fill="#eff6ff" stroke="${C.prefill}" stroke-width="2"/>
                                    <text x="150" y="30" text-anchor="middle" font-weight="bold" fill="${C.prefill}">Prefill Cluster (高算力)</text>
                                    <text x="150" y="50" text-anchor="middle" font-size="10" fill="${C.sub}">A100/H100 Nodes</text>

                                    <!-- Decode Cluster -->
                                    <rect x="400" y="0" width="300" height="70" rx="8" fill="#ecfdf5" stroke="${C.decode}" stroke-width="2"/>
                                    <text x="550" y="30" text-anchor="middle" font-weight="bold" fill="${C.decode}">Decode Cluster (大显存)</text>
                                    <text x="550" y="50" text-anchor="middle" font-size="10" fill="${C.sub}">L20/L40 Nodes</text>
                                </g>

                                <!-- 3. Network Layer (Separate) -->
                                <g transform="translate(50, 180)">
                                    <rect x="0" y="0" width="700" height="30" rx="15" fill="#f3e8ff" stroke="${C.network}" stroke-width="2"/>
                                    <text x="350" y="20" text-anchor="middle" font-weight="bold" fill="${C.network}" font-size="11">高速网络层 (RDMA / InfiniBand / 400Gbps Fabric)</text>
                                    
                                    <!-- Connectors -->
                                    <line x1="150" y1="-20" x2="150" y2="0" stroke="${C.prefill}" stroke-width="2"/>
                                    <line x1="550" y1="-20" x2="550" y2="0" stroke="${C.decode}" stroke-width="2"/>
                                </g>

                                <!-- 4. Storage Layer (Separate) -->
                                <g transform="translate(50, 230)">
                                    <rect x="0" y="0" width="700" height="40" rx="4" fill="#fffbeb" stroke="${C.infra}" stroke-width="2"/>
                                    <text x="350" y="25" text-anchor="middle" font-weight="bold" fill="${C.infra}">存储层 (Global KV Cache Pool / HBM / DDR / NVMe)</text>
                                    
                                    <!-- Connectors -->
                                    <line x1="150" y1="-20" x2="150" y2="0" stroke="${C.infra}" stroke-width="2" stroke-dasharray="4"/>
                                    <line x1="550" y1="-20" x2="550" y2="0" stroke="${C.infra}" stroke-width="2" stroke-dasharray="4"/>
                                </g>

                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card">
                                <div class="card-title" style="color:${C.prefill}"><i class="fa-solid fa-book"></i> 原理 (Principle)</div>
                                <div class="card-body">
                                    将推理过程拆解。<b>Prefill 阶段</b>是计算密集型，使用高算力实例；<b>Decode 阶段</b>是访存密集型，使用高显存带宽实例。中间通过独立的高速网络层传输数据。
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.infra}"><i class="fa-solid fa-database"></i> Global KV Pool</div>
                                <div class="card-body">
                                    <b>定义：</b>逻辑上统一的显存池，跨越所有计算节点，通过 RDMA 互联。<br>
                                    <b>机制：</b>Prefill 计算完的 KV 不留在本地，而是直接写入目标 Decode 节点的地址空间（或共享存储），实现<b>零拷贝传输</b>与状态解耦。
                                </div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title"><i class="fa-solid fa-triangle-exclamation"></i> 挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol style="padding-left:20px; margin:0;">
                                        <li><b>网络带宽瓶颈：</b>KV Cache 数据量极大（几百 MB 到 GB 级）。必须依赖 400Gbps+ 的 InfiniBand/RDMA 网络。</li>
                                        <li><b>状态一致性：</b>需实现分布式协议来管理 KV Block 的生命周期、引用计数和驱逐策略。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            // --- PREFILL: BLOCK SPARSE ---
            {
                id: 'block-sparse',
                group: '2. 预填充层',
                title: 'Block Sparse Attention (块稀疏注意力)',
                meta: '长文本计算优化',
                color: C.prefill,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">Block-wise Computation Flow</div>
                            <svg width="800" height="280" viewBox="0 0 800 280">
                                ${defs}
                                
                                <!-- 1. Grid Partitioning -->
                                <g transform="translate(50, 40)">
                                    <text x="75" y="-15" text-anchor="middle" font-weight="bold" fill="${C.text}" font-size="11">1. 块划分 (Partitioning)</text>
                                    <!-- Q Matrix -->
                                    <rect x="0" y="0" width="20" height="150" fill="#fff" stroke="${C.text}"/>
                                    <text x="10" y="165" text-anchor="middle" font-size="10">Q</text>
                                    
                                    <text x="35" y="75" text-anchor="middle" font-size="14">×</text>
                                    
                                    <!-- K^T Matrix (Grid) -->
                                    <g transform="translate(50, 0)">
                                        <rect x="0" y="0" width="150" height="20" fill="#fff" stroke="${C.text}"/>
                                        <text x="75" y="165" text-anchor="middle" font-size="10">Kᵀ</text>
                                        
                                        <!-- Visualizing Grid on a Matrix representation -->
                                        <rect x="0" y="30" width="150" height="120" fill="#f8fafc" stroke="${C.sub}" stroke-dasharray="2"/>
                                        <!-- Horizontal Lines -->
                                        <line x1="0" y1="60" x2="150" y2="60" stroke="${C.sub}" stroke-opacity="0.3"/>
                                        <line x1="0" y1="90" x2="150" y2="90" stroke="${C.sub}" stroke-opacity="0.3"/>
                                        <line x1="0" y1="120" x2="150" y2="120" stroke="${C.sub}" stroke-opacity="0.3"/>
                                        <!-- Vertical Lines -->
                                        <line x1="30" y1="30" x2="30" y2="150" stroke="${C.sub}" stroke-opacity="0.3"/>
                                        <line x1="60" y1="30" x2="60" y2="150" stroke="${C.sub}" stroke-opacity="0.3"/>
                                        <line x1="90" y1="30" x2="90" y2="150" stroke="${C.sub}" stroke-opacity="0.3"/>
                                        <line x1="120" y1="30" x2="120" y2="150" stroke="${C.sub}" stroke-opacity="0.3"/>
                                        
                                        <!-- Highlight one block -->
                                        <rect x="60" y="60" width="30" height="30" fill="${C.prefill}" fill-opacity="0.2" stroke="${C.prefill}" stroke-width="2"/>
                                        <text x="75" y="78" text-anchor="middle" font-size="8" fill="${C.prefill}">Block(i,j)</text>
                                    </g>
                                </g>

                                <!-- Arrow -->
                                <line x1="280" y1="100" x2="320" y2="100" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>

                                <!-- 2. Mask Generation -->
                                <g transform="translate(340, 40)">
                                    <text x="75" y="-15" text-anchor="middle" font-weight="bold" fill="${C.text}" font-size="11">2. 掩码判定 (Determination)</text>
                                    <rect x="0" y="0" width="150" height="150" fill="#fff" stroke="${C.text}"/>
                                    
                                    <!-- Global (Sink) -->
                                    <rect x="0" y="0" width="30" height="150" fill="${C.gateway}" opacity="0.6"/>
                                    <text x="15" y="165" text-anchor="middle" font-size="9" fill="${C.gateway}">Global</text>
                                    <!-- Logic Text Global -->
                                    <text x="-5" y="10" text-anchor="end" font-size="8" fill="${C.gateway}" font-family="monospace">if col < S</text>

                                    <!-- Local (Diagonal) -->
                                    <rect x="0" y="0" width="30" height="30" fill="${C.decode}"/>
                                    <rect x="30" y="30" width="30" height="30" fill="${C.decode}"/>
                                    <rect x="60" y="60" width="30" height="30" fill="${C.decode}"/>
                                    <rect x="90" y="90" width="30" height="30" fill="${C.decode}"/>
                                    <rect x="120" y="120" width="30" height="30" fill="${C.decode}"/>
                                    <!-- Logic Text Local -->
                                    <text x="160" y="140" font-size="8" fill="${C.decode}" font-family="monospace">if |i-j| < W</text>
                                    
                                    <!-- Skipped -->
                                    <text x="100" y="50" font-size="10" fill="${C.sub}" opacity="0.5">0</text>
                                    <text x="50" y="120" font-size="10" fill="${C.sub}" opacity="0.5">0</text>
                                </g>

                                <!-- Arrow -->
                                <line x1="510" y1="100" x2="550" y2="100" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>

                                <!-- 3. Computation -->
                                <g transform="translate(570, 60)">
                                    <text x="80" y="-35" text-anchor="middle" font-weight="bold" fill="${C.text}" font-size="11">3. 稀疏计算 (Compute)</text>
                                    
                                    <!-- SRAM/Tensor Core -->
                                    <rect x="0" y="0" width="160" height="100" rx="8" fill="#f0fdf4" stroke="${C.decode}"/>
                                    <text x="80" y="20" text-anchor="middle" font-weight="bold" font-size="10" fill="${C.decode}">GPU SRAM / Tensor Core</text>
                                    
                                    <!-- Pseudo Code Logic -->
                                    <g transform="translate(20, 35)">
                                        <text x="0" y="0" font-family="monospace" font-size="9">for block(i,j):</text>
                                        <text x="10" y="12" font-family="monospace" font-size="9" fill="${C.danger}">if mask[i,j] == 0: skip</text>
                                        <text x="10" y="24" font-family="monospace" font-size="9">else:</text>
                                        <text x="20" y="36" font-family="monospace" font-size="9">load Q[i], K[j]</text>
                                        <text x="20" y="48" font-family="monospace" font-size="9">S = Q[i] @ K[j].T</text>
                                    </g>
                                </g>

                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card">
                                <div class="card-title" style="color:${C.prefill}"><i class="fa-solid fa-th-large"></i> 掩码判定逻辑 (Logic)</div>
                                <div class="card-body">
                                    对 B x B 的块 M(i,j)，Mask 值为 1 (计算) 若满足以下任一条件，否则为 0 (跳过)：
                                    <ul style="padding-left:15px; margin-top:5px;">
                                        <li><b>Local (滑动窗口):</b> |i - j| < W (保留对角线附近的上下文)</li>
                                        <li><b>Global (全局锚点):</b> j < S (保留 System Prompt 等关键首部)</li>
                                        <li><b>Random:</b> 以概率 P 随机保留 (非必须)</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.prefill}"><i class="fa-solid fa-microchip"></i> 计算流 (Pipeline)</div>
                                <div class="card-body">
                                    基于 Triton/CUDA Kernel 实现：<br>
                                    1. <b>Skip:</b> 线程块 (Thread Block) 读取 Mask，若为 0 直接退出。<br>
                                    2. <b>Load:</b> 仅将有效块从 HBM 加载到 SRAM。<br>
                                    3. <b>MMA:</b> 利用 Tensor Core 进行矩阵乘法。
                                </div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title"><i class="fa-solid fa-triangle-exclamation"></i> 挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol style="padding-left:20px; margin:0;">
                                        <li><b>负载均衡 (Load Balance)：</b>不同行的非零块数量差异大，简单并行会导致 GPU 线程空闲等待。需动态分配线程块。</li>
                                        <li><b>精度恢复：</b>稀疏化可能导致长程信息丢失，需通过微调 (Fine-tuning) 适应。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: 'radix',
                group: '2. 预填充层',
                title: 'Radix Attention (前缀树)',
                meta: 'KV Cache 复用',
                color: C.prefill,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">Radix Tree Structure</div>
                            <svg width="800" height="280" viewBox="0 0 800 280">
                                ${defs}
                                <!-- Root -->
                                <g transform="translate(300, 20)">
                                    <rect x="0" y="0" width="200" height="60" rx="4" fill="#eff6ff" stroke="${C.prefill}" stroke-width="2"/>
                                    <text x="100" y="25" text-anchor="middle" font-weight="bold" fill="${C.prefill}">根节点: System Prompt</text>
                                    <text x="100" y="45" text-anchor="middle" font-size="10" fill="${C.sub}" font-family="monospace">"You are an assistant..."</text>
                                </g>

                                <!-- Lines -->
                                <path d="M400 80 L200 130" stroke="${C.line}" stroke-width="2" />
                                <path d="M400 80 L600 130" stroke="${C.line}" stroke-width="2" />

                                <!-- Nodes L1 -->
                                <g transform="translate(100, 130)">
                                    <rect x="0" y="0" width="200" height="60" rx="4" fill="#fff" stroke="${C.sub}" stroke-width="2"/>
                                    <text x="100" y="25" text-anchor="middle" font-weight="bold" fill="${C.text}">用户 A 历史</text>
                                    <text x="100" y="45" text-anchor="middle" font-size="10" fill="${C.sub}" font-family="monospace">"Analyze this PDF"</text>
                                    <text x="180" y="75" font-size="10" fill="${C.decode}" font-weight="bold">Hit!</text>
                                </g>

                                <g transform="translate(500, 130)">
                                    <rect x="0" y="0" width="200" height="60" rx="4" fill="#fff" stroke="${C.sub}" stroke-width="2" stroke-dasharray="4"/>
                                    <text x="100" y="25" text-anchor="middle" font-weight="bold" fill="${C.sub}">用户 B 历史</text>
                                    <text x="100" y="45" text-anchor="middle" font-size="10" fill="${C.sub}" font-family="monospace">"Write a snake game"</text>
                                    <text x="180" y="75" font-size="10" fill="${C.sub}">Cold</text>
                                </g>

                                <!-- Leaf -->
                                <path d="M200 190 L200 220" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>
                                <g transform="translate(120, 220)">
                                    <rect x="0" y="0" width="160" height="40" rx="4" fill="#ecfdf5" stroke="${C.decode}" stroke-width="2"/>
                                    <text x="80" y="25" text-anchor="middle" font-weight="bold" fill="${C.decode}">新请求 Query</text>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card">
                                <div class="card-title" style="color:${C.prefill}"><i class="fa-solid fa-book"></i> 原理 (Principle)</div>
                                <div class="card-body">
                                    将 KV Cache 维护为一棵<b>基数树 (Radix Tree)</b>。树的节点代表 Token 序列片段。当新请求的前缀（如 System Prompt + 几轮对话）与树中路径匹配时，直接映射到已有的物理显存块。
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.prefill}"><i class="fa-solid fa-desktop"></i> 举个例子 (Example)</div>
                                <div class="card-body">
                                    <b>多轮对话 Agent：</b><br>
                                    用户问："解释量子力学" (生成 Cache A)。<br>
                                    用户追问："用简单的语言"。<br>
                                    系统识别到前缀 "解释量子力学" 已存在，直接复用 Cache A，仅需计算 "用简单的语言" 这 6 个 Token，<b>Prefill 耗时接近 0ms</b>。
                                </div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title"><i class="fa-solid fa-triangle-exclamation"></i> 挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol style="padding-left:20px; margin:0;">
                                        <li><b>前缀敏感性：</b>如果 Prompt 头部包含随机 ID 或时间戳，会导致无法匹配根节点，缓存完全失效。</li>
                                        <li><b>复杂的驱逐策略：</b>树形结构的 LRU 驱逐比线性结构复杂，需要维护父子节点的引用关系，防止误删被共享的父节点。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: 'chunked',
                group: '2. 预填充层',
                title: 'Chunked Prefill (分块预填充)',
                meta: 'GPU 调度优化',
                color: C.prefill,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">GPU Timeline Comparison</div>
                            <svg width="800" height="280" viewBox="0 0 800 280">
                                ${defs}
                                
                                <!-- Scenario 1: Without Chunking -->
                                <text x="30" y="30" font-weight="bold" fill="${C.text}" font-size="12">🔴 传统模式 (无分块)</text>
                                <line x1="30" y1="80" x2="750" y2="80" stroke="${C.line}" stroke-width="1"/>
                                
                                <!-- Long Job -->
                                <rect x="30" y="50" width="400" height="30" fill="#fecaca" stroke="${C.danger}"/>
                                <text x="230" y="70" text-anchor="middle" font-size="10" fill="${C.danger}">长文档 Prefill (2000ms)</text>
                                
                                <!-- Short Job Arrives -->
                                <line x1="150" y1="40" x2="150" y2="90" stroke="${C.text}" stroke-dasharray="2"/>
                                <text x="150" y="35" text-anchor="middle" font-size="9" fill="${C.text}">短请求到达</text>
                                
                                <!-- Short Job Waiting -->
                                <rect x="150" y="85" width="280" height="10" fill="#cbd5e1" opacity="0.5"/>
                                <text x="290" y="105" text-anchor="middle" font-size="9" fill="${C.sub}">排队等待 (Head-of-Line Blocking)</text>
                                
                                <!-- Short Job Exec -->
                                <rect x="440" y="50" width="50" height="30" fill="#d1fae5" stroke="${C.decode}"/>
                                <text x="465" y="70" text-anchor="middle" fill="${C.decode}" font-size="10">Decode</text>

                                <!-- TTFT Arrow 1 -->
                                <line x1="150" y1="110" x2="440" y2="110" stroke="${C.danger}" stroke-width="2" marker-end="url(#arrow)"/>
                                <text x="300" y="125" text-anchor="middle" font-size="10" fill="${C.danger}" font-weight="bold">TTFT: > 1800ms (卡顿)</text>


                                <!-- Scenario 2: With Chunking -->
                                <text x="30" y="160" font-weight="bold" fill="${C.text}" font-size="12">🟢 Chunked Prefill (分块交错)</text>
                                <line x1="30" y1="210" x2="750" y2="210" stroke="${C.line}" stroke-width="1"/>

                                <!-- Chunk 1 -->
                                <rect x="30" y="180" width="100" height="30" fill="#dbeafe" stroke="${C.prefill}"/>
                                <text x="80" y="200" text-anchor="middle" font-size="10" fill="${C.prefill}">Chunk 1</text>

                                <!-- Short Job Arrives -->
                                <line x1="150" y1="170" x2="150" y2="220" stroke="${C.text}" stroke-dasharray="2"/>
                                <text x="150" y="165" text-anchor="middle" font-size="9" fill="${C.text}">短请求到达</text>

                                <!-- Interleaved Decode -->
                                <rect x="155" y="180" width="50" height="30" fill="#d1fae5" stroke="${C.decode}"/>
                                <text x="180" y="200" text-anchor="middle" font-size="10" fill="${C.decode}">插队 Decode</text>

                                <!-- Chunk 2 -->
                                <rect x="210" y="180" width="100" height="30" fill="#dbeafe" stroke="${C.prefill}"/>
                                <text x="260" y="200" text-anchor="middle" font-size="10" fill="${C.prefill}">Chunk 2</text>

                                <!-- Chunk 3 -->
                                <rect x="315" y="180" width="100" height="30" fill="#dbeafe" stroke="${C.prefill}"/>
                                <text x="365" y="200" text-anchor="middle" font-size="10" fill="${C.prefill}">Chunk 3</text>

                                <!-- TTFT Arrow 2 -->
                                <line x1="150" y1="240" x2="155" y2="240" stroke="${C.decode}" stroke-width="2" marker-end="url(#arrow)"/>
                                <text x="180" y="255" text-anchor="middle" font-size="10" fill="${C.decode}" font-weight="bold">TTFT: ~50ms (流畅)</text>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card">
                                <div class="card-title" style="color:${C.prefill}"><i class="fa-solid fa-book"></i> 原理 (Principle)</div>
                                <div class="card-body">
                                    将超长的 Prefill 任务切分成多个小块 (Chunk，例如 512 tokens)。在 GPU 执行完一个 Chunk 后，调度器会暂停该任务，插入处理其他高优先级的 Decode 任务（如聊天生成），然后再恢复执行下一个 Chunk。
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.prefill}"><i class="fa-solid fa-desktop"></i> 举个例子 (Example)</div>
                                <div class="card-body">
                                    <b>混合负载场景：</b><br>
                                    用户 A 上传了一本 10万字的小说（长任务）；<br>
                                    用户 B 发了一句 "你好"（短任务）。<br>
                                    <b>效果：</b>系统将小说切分处理，在处理间隙快速响应用户 B。用户 B 感觉不到卡顿，就像用户 A 不存在一样。
                                </div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title"><i class="fa-solid fa-triangle-exclamation"></i> 挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol style="padding-left:20px; margin:0;">
                                        <li><b>KV 状态开销：</b>频繁切换任务需要保存/恢复 KV Cache 状态，如果显存带宽不足，切换开销会很大。</li>
                                        <li><b>总吞吐下降：</b>虽然降低了延迟 (Latency)，但由于切分带来的 Overhead，处理完长任务的绝对总时间 (Make-span) 会略微增加。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // --- DECODE: STRUCT GEN ---
            {
                id: 'struct-gen',
                group: '3. 解码层',
                title: 'Structured Gen 结构化生成',
                meta: 'JSON Schema 约束',
                color: C.decode,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">基于 Trie-FSM 的采样掩码 (Enum 约束)</div>
                            <svg width="800" height="280" viewBox="0 0 800 280">
                                ${defs}
                                
                                <!-- 1. Context -->
                                <g transform="translate(30, 40)">
                                    <text x="0" y="20" font-weight="bold" font-size="11" fill="${C.text}">当前生成状态:</text>
                                    <rect x="0" y="30" width="160" height="60" rx="4" fill="#fff" stroke="${C.text}" stroke-width="1"/>
                                    <text x="10" y="55" font-family="monospace" font-size="11">"mode": <tspan fill="${C.decode}" font-weight="bold">"s_</tspan></text>
                                    <text x="10" y="80" font-family="monospace" font-size="9" fill="${C.sub}">(Schema: "safe" | "speed")</text>
                                </g>

                                <!-- Arrow -->
                                <line x1="170" y1="60" x2="210" y2="60" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>

                                <!-- 2. FSM / Trie -->
                                <g transform="translate(220, 20)">
                                    <rect x="0" y="0" width="240" height="200" rx="8" fill="#f0fdf4" stroke="${C.decode}" stroke-width="2"/>
                                    <text x="120" y="25" text-anchor="middle" font-weight="bold" fill="${C.decode}" font-size="12">约束状态机 (Trie FSM)</text>
                                    
                                    <!-- Root -->
                                    <circle cx="40" cy="100" r="15" fill="#fff" stroke="${C.decode}"/>
                                    <text x="40" y="104" text-anchor="middle" font-size="10">Start</text>

                                    <!-- 's' -->
                                    <path d="M 55 100 L 95 100" stroke="${C.decode}" stroke-width="2" marker-end="url(#arrow)"/>
                                    <circle cx="110" cy="100" r="15" fill="#d1fae5" stroke="${C.decode}" stroke-width="3"/>
                                    <text x="110" y="104" text-anchor="middle" font-size="10" font-weight="bold">s</text>
                                    <text x="110" y="135" text-anchor="middle" font-size="9" fill="${C.decode}">当前状态</text>

                                    <!-- Branch 'a' (safe) -->
                                    <path d="M 120 90 L 160 60" stroke="${C.decode}" stroke-width="1" stroke-dasharray="2"/>
                                    <circle cx="170" cy="55" r="12" fill="#fff" stroke="${C.decode}"/>
                                    <text x="170" y="59" text-anchor="middle" font-size="9">a</text>
                                    <text x="200" y="59" font-size="9" fill="${C.sub}">...fe</text>

                                    <!-- Branch 'p' (speed) -->
                                    <path d="M 120 110 L 160 140" stroke="${C.decode}" stroke-width="1" stroke-dasharray="2"/>
                                    <circle cx="170" cy="145" r="12" fill="#fff" stroke="${C.decode}"/>
                                    <text x="170" y="149" text-anchor="middle" font-size="9">p</text>
                                    <text x="200" y="149" font-size="9" fill="${C.sub}">...eed</text>
                                    
                                    <text x="120" y="180" text-anchor="middle" font-size="10" font-weight="bold" fill="${C.decode}">Next Allowed: {'a', 'p'}</text>
                                </g>

                                <!-- Arrow -->
                                <line x1="470" y1="120" x2="510" y2="120" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>

                                <!-- 3. Logit Masking -->
                                <g transform="translate(520, 20)">
                                    <text x="100" y="15" text-anchor="middle" font-weight="bold" fill="${C.text}">Logit 掩码操作</text>
                                    
                                    <!-- Vocabulary Stack -->
                                    <g transform="translate(20, 30)">
                                        <!-- Token 'a' -->
                                        <rect x="0" y="0" width="160" height="25" fill="#d1fae5" stroke="${C.decode}"/>
                                        <text x="10" y="17" font-family="monospace" font-size="11">"a"</text>
                                        <text x="130" y="17" font-size="11" fill="${C.decode}" font-weight="bold">OK</text>
                                        
                                        <!-- Token 'b' -->
                                        <rect x="0" y="30" width="160" height="25" fill="#fee2e2" stroke="${C.danger}"/>
                                        <text x="10" y="47" font-family="monospace" font-size="11">"b"</text>
                                        <text x="100" y="47" font-size="10" fill="${C.danger}">Mask (-inf)</text>

                                        <!-- Token 'p' -->
                                        <rect x="0" y="60" width="160" height="25" fill="#d1fae5" stroke="${C.decode}"/>
                                        <text x="10" y="77" font-family="monospace" font-size="11">"p"</text>
                                        <text x="130" y="77" font-size="11" fill="${C.decode}" font-weight="bold">OK</text>
                                        
                                        <!-- Token 's' -->
                                        <rect x="0" y="90" width="160" height="25" fill="#fee2e2" stroke="${C.danger}"/>
                                        <text x="10" y="107" font-family="monospace" font-size="11">"s"</text>
                                        <text x="100" y="107" font-size="10" fill="${C.danger}">Mask (-inf)</text>
                                        
                                        <!-- Others -->
                                        <rect x="0" y="120" width="160" height="20" fill="#f1f5f9" stroke="none"/>
                                        <text x="80" y="134" text-anchor="middle" font-size="9" fill="${C.sub}">... other tokens ...</text>
                                    </g>
                                    
                                    <!-- Result Arrow -->
                                    <line x1="100" y1="160" x2="100" y2="180" stroke="${C.text}" stroke-width="2" marker-end="url(#arrow)"/>
                                    
                                    <g transform="translate(50, 190)">
                                        <rect x="0" y="0" width="100" height="40" rx="4" fill="#fff" stroke="${C.decode}" stroke-width="2"/>
                                        <text x="50" y="25" text-anchor="middle" font-weight="bold" fill="${C.decode}">Sample("a")</text>
                                    </g>
                                </g>

                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card">
                                <div class="card-title" style="color:${C.decode}"><i class="fa-solid fa-book"></i> 原理 (Principle)</div>
                                <div class="card-body">
                                    将 JSON Schema 或 Regex 编译为 <b>Trie (字典树)</b> 或 <b>PDA (下推自动机)</b>。在每一步生成时，根据当前前缀在自动机中的状态，计算合法的下一跳字符集合，构建掩码。
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.decode}"><i class="fa-solid fa-desktop"></i> 复杂实例 (Example)</div>
                                <div class="card-body">
                                    <b>Schema:</b> <code>mode: Enum["safe", "speed"]</code><br>
                                    <b>当前前缀:</b> <code>"s"</code><br>
                                    <b>FSM 状态:</b> 已匹配 "s"，分支为 "safe"('a') 或 "speed"('p')。<br>
                                    <b>动作:</b> Mask 掉除 "a" 和 "p" 以外的所有 50,000+ 个 Token。
                                </div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title"><i class="fa-solid fa-triangle-exclamation"></i> 挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol style="padding-left:20px; margin:0;">
                                        <li><b>Token 匹配歧义：</b>Tokenizer 可能将 "safe" 编码为 单个Token，也可能切分为 "sa"+"fe"。FSM 必须能够处理 Byte 级的子词匹配。</li>
                                        <li><b>动态 Schema：</b>如果 Schema 中包含递归定义（如树结构），FSM 状态空间可能无限大，需动态懒加载构建。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // --- DECODE: SPECULATIVE (FINAL) ---
            {
                id: 'speculative',
                group: '3. 解码层',
                title: 'Speculative Decoding 投机采样',
                meta: 'Draft & Verify 机制',
                color: C.decode,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">Context: "The cat is on"</div>
                            <svg width="800" height="280" viewBox="0 0 800 280">
                                ${defs}
                                
                                <!-- Draft Phase -->
                                <g transform="translate(20, 80)">
                                    <text x="60" y="-10" text-anchor="middle" font-weight="bold" fill="${C.sub}">Draft Model (小模型)</text>
                                    <rect x="0" y="0" width="120" height="70" rx="4" fill="#f0fdf4" stroke="${C.decode}" stroke-dasharray="4"/>
                                    <text x="60" y="20" text-anchor="middle" fill="${C.decode}" font-size="11">生成 4 Tokens</text>
                                    
                                    <!-- Tokens -->
                                    <g transform="translate(10, 35)">
                                        <rect x="0" y="0" width="22" height="20" fill="#fff" stroke="${C.decode}"/><text x="11" y="14" text-anchor="middle" font-size="9">the</text>
                                        <rect x="25" y="0" width="22" height="20" fill="#fff" stroke="${C.decode}"/><text x="36" y="14" text-anchor="middle" font-size="9">mat</text>
                                        <rect x="50" y="0" width="22" height="20" fill="#fff" stroke="${C.decode}"/><text x="61" y="14" text-anchor="middle" font-size="8">sleep</text>
                                        <rect x="75" y="0" width="22" height="20" fill="#fff" stroke="${C.decode}"/><text x="86" y="14" text-anchor="middle" font-size="9">now</text>
                                    </g>
                                </g>

                                <!-- Arrow to Matrix -->
                                <line x1="140" y1="115" x2="170" y2="115" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>

                                <!-- Matrix Construction -->
                                <g transform="translate(180, 70)">
                                    <rect x="0" y="0" width="90" height="90" fill="#f8fafc" stroke="${C.line}" stroke-width="1"/>
                                    <text x="45" y="-10" text-anchor="middle" font-size="10" fill="${C.sub}">构造输入矩阵</text>
                                    
                                    <!-- Matrix visual -->
                                    <g transform="translate(15, 15)">
                                        <rect x="0" y="0" width="60" height="12" fill="#e2e8f0"/><text x="30" y="9" text-anchor="middle" font-size="8" font-family="monospace">..on the</text>
                                        <rect x="0" y="15" width="60" height="12" fill="#e2e8f0"/><text x="30" y="24" text-anchor="middle" font-size="8" font-family="monospace">..on the mat</text>
                                        <rect x="0" y="30" width="60" height="12" fill="#e2e8f0"/><text x="30" y="39" text-anchor="middle" font-size="8" font-family="monospace">..mat sleep</text>
                                        <rect x="0" y="45" width="60" height="12" fill="#e2e8f0"/><text x="30" y="54" text-anchor="middle" font-size="8" font-family="monospace">..sleep now</text>
                                        <text x="30" y="70" text-anchor="middle" font-size="8" fill="${C.sub}">(Tree/Pads)</text>
                                    </g>
                                </g>

                                <line x1="270" y1="115" x2="300" y2="115" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>

                                <!-- Verify Process -->
                                <g transform="translate(310, 40)">
                                    <rect x="0" y="0" width="340" height="160" rx="8" fill="#fff" stroke="${C.decode}" stroke-width="2"/>
                                    <text x="170" y="20" text-anchor="middle" font-weight="bold" fill="${C.decode}">Target Model (大模型)</text>
                                    <text x="170" y="35" text-anchor="middle" font-size="10" fill="${C.sub}">一次 Forward Pass (并行评分)</text>

                                    <!-- Internal Logic -->
                                    <g transform="translate(20, 50)">
                                        <line x1="0" y1="45" x2="300" y2="45" stroke="#e2e8f0" stroke-width="1"/>
                                        
                                        <!-- Step 1: Input -->
                                        <text x="0" y="10" font-size="10" fill="${C.sub}">Input:</text>
                                        <g transform="translate(40, 0)">
                                            <rect x="0" y="0" width="20" height="15" fill="#f1f5f9" stroke="#94a3b8"/><text x="10" y="11" text-anchor="middle" font-size="9">the</text>
                                            <rect x="25" y="0" width="20" height="15" fill="#f1f5f9" stroke="#94a3b8"/><text x="35" y="11" text-anchor="middle" font-size="9">mat</text>
                                            <rect x="50" y="0" width="25" height="15" fill="#f1f5f9" stroke="#94a3b8"/><text x="62" y="11" text-anchor="middle" font-size="9">sleep</text>
                                            <rect x="80" y="0" width="20" height="15" fill="#f1f5f9" stroke="#94a3b8"/><text x="90" y="11" text-anchor="middle" font-size="9">now</text>
                                        </g>

                                        <!-- Step 2: Scores -->
                                        <text x="0" y="35" font-size="10" fill="${C.sub}">Score:</text>
                                        <g transform="translate(40, 25)">
                                            <text x="10" y="10" text-anchor="middle" font-size="9" fill="${C.decode}">0.99</text>
                                            <text x="35" y="10" text-anchor="middle" font-size="9" fill="${C.decode}">0.95</text>
                                            <text x="62" y="10" text-anchor="middle" font-size="9" fill="${C.decode}">0.88</text>
                                            <text x="90" y="10" text-anchor="middle" font-size="9" fill="${C.danger}">0.01</text>
                                        </g>

                                        <!-- Step 3: Check -->
                                        <text x="0" y="70" font-size="10" fill="${C.sub}">Check:</text>
                                        <g transform="translate(40, 60)">
                                            <!-- T1 -->
                                            <circle cx="10" cy="10" r="8" fill="#d1fae5"/><text x="10" y="14" text-anchor="middle" fill="${C.decode}" font-size="10">✓</text>
                                            <line x1="20" y1="10" x2="30" y2="10" stroke="${C.decode}"/>
                                            
                                            <!-- T2 -->
                                            <circle cx="35" cy="10" r="8" fill="#d1fae5"/><text x="35" y="14" text-anchor="middle" fill="${C.decode}" font-size="10">✓</text>
                                            <line x1="45" y1="10" x2="55" y2="10" stroke="${C.decode}"/>

                                            <!-- T3 -->
                                            <circle cx="62" cy="10" r="8" fill="#d1fae5"/><text x="62" y="14" text-anchor="middle" fill="${C.decode}" font-size="10">✓</text>
                                            <line x1="72" y1="10" x2="82" y2="10" stroke="${C.decode}"/>

                                            <!-- T4 -->
                                            <circle cx="90" cy="10" r="8" fill="#fee2e2"/><text x="90" y="14" text-anchor="middle" fill="${C.danger}" font-size="10">✗</text>
                                            
                                            <text x="140" y="14" font-size="10" fill="${C.sub}">拒绝 "now"</text>
                                            <text x="140" y="26" font-size="10" fill="${C.decode}" font-weight="bold">重采样: "sound"</text>
                                        </g>
                                    </g>
                                </g>

                                <line x1="650" y1="115" x2="680" y2="115" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>

                                <!-- Result -->
                                <g transform="translate(690, 85)">
                                    <text x="50" y="-10" text-anchor="middle" font-weight="bold" fill="${C.sub}">最终接受</text>
                                    <rect x="0" y="0" width="100" height="60" rx="4" fill="#f0fdf4" stroke="${C.decode}" stroke-width="2"/>
                                    <text x="50" y="25" text-anchor="middle" font-weight="bold" fill="${C.decode}">3 Tokens</text>
                                    <text x="50" y="45" text-anchor="middle" font-size="10" fill="${C.sub}">+ 1 修正</text>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card">
                                <div class="card-title" style="color:${C.decode}"><i class="fa-solid fa-book"></i> 原理 (Principle)</div>
                                <div class="card-body">
                                    <b>Draft-Verify 机制：</b><br>
                                    1. <b>Draft:</b> 小模型快速串行生成 N 个 Token。<br>
                                    2. <b>Verify:</b> 大模型将这 N 个 Token 拼成矩阵（或树），进行<b>一次 Forward Pass</b>，并行计算所有位置的概率分布，验证 Draft 是否正确。
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.decode}"><i class="fa-solid fa-desktop"></i> 实例 (Example)</div>
                                <div class="card-body">
                                    <b>Context:</b> "The cat is on"<br>
                                    <b>Draft:</b> "the", "mat", "sleep", "now"<br>
                                    <b>Target:</b> 接受前3个("the mat sleep")，拒绝"now" (大模型修正为"sound")。<br>
                                    <b>收益:</b> 1次大模型推理，生成了3个Token。
                                </div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title"><i class="fa-solid fa-triangle-exclamation"></i> 挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol style="padding-left:20px; margin:0;">
                                        <li><b>模型对齐：</b>Draft Model 必须与 Target Model 的分布足够接近，否则接受率低，反而拖慢速度。</li>
                                        <li><b>动态调整：</b>需实时监控接受率。若任务很难（高熵），自动关闭投机模式。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // --- INFRA: OFFLOAD ---
            {
                id: 'offload',
                group: '4. 基础设施层',
                title: 'KV Offloading 分级存储',
                meta: 'Swap In/Out 机制',
                color: C.infra,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">Memory Hierarchy & Data Flow</div>
                            <svg width="800" height="280" viewBox="0 0 800 280">
                                ${defs}
                                <!-- GPU -->
                                <g transform="translate(100, 40)">
                                    <rect x="0" y="0" width="160" height="200" rx="8" fill="#fffbeb" stroke="${C.infra}" stroke-width="2"/>
                                    <text x="80" y="30" text-anchor="middle" font-weight="bold" fill="${C.infra}">GPU VRAM (L1)</text>
                                    <text x="80" y="45" text-anchor="middle" font-size="10" fill="${C.sub}">HBM3 (Active/Hot)</text>
                                    
                                    <!-- Blocks -->
                                    <rect x="20" y="60" width="120" height="20" fill="${C.infra}" opacity="0.9"/>
                                    <rect x="20" y="85" width="120" height="20" fill="${C.infra}" opacity="0.9"/>
                                    <rect x="20" y="110" width="120" height="20" fill="#fff" stroke="${C.infra}" stroke-dasharray="2"/>
                                    <text x="80" y="125" text-anchor="middle" font-size="10" fill="${C.sub}">Swap Victim</text>
                                </g>

                                <!-- Channel -->
                                <g transform="translate(300, 120)">
                                    <line x1="0" y1="0" x2="200" y2="0" stroke="${C.text}" stroke-width="4"/>
                                    <text x="100" y="-15" text-anchor="middle" font-size="11" font-weight="bold">PCIe Gen5 x16 (64GB/s)</text>
                                    
                                    <path d="M50 10 L150 10" stroke="${C.sub}" marker-end="url(#arrow)"/>
                                    <text x="100" y="25" text-anchor="middle" font-size="10">Evict (LRU Policy)</text>
                                    
                                    <path d="M150 40 L50 40" stroke="${C.sub}" marker-end="url(#arrow)"/>
                                    <text x="100" y="55" text-anchor="middle" font-size="10">Prefetch (Async)</text>
                                </g>

                                <!-- CPU -->
                                <g transform="translate(540, 40)">
                                    <rect x="0" y="0" width="160" height="200" rx="8" fill="#f8fafc" stroke="${C.text}" stroke-width="2"/>
                                    <text x="80" y="30" text-anchor="middle" font-weight="bold" fill="${C.text}">CPU Memory (L2)</text>
                                    <text x="80" y="45" text-anchor="middle" font-size="10" fill="${C.sub}">Pinned DRAM (Warm)</text>
                                    
                                    <!-- Blocks -->
                                    <rect x="20" y="60" width="120" height="20" fill="${C.sub}" opacity="0.2"/>
                                    <rect x="20" y="85" width="120" height="20" fill="${C.sub}" opacity="0.2"/>
                                    <rect x="20" y="110" width="120" height="20" fill="${C.infra}" opacity="0.4"/>
                                    <rect x="20" y="135" width="120" height="20" fill="${C.sub}" opacity="0.2"/>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card">
                                <div class="card-title" style="color:${C.infra}"><i class="fa-solid fa-microchip"></i> 核心技术细节 (Details)</div>
                                <div class="card-body">
                                    <ul style="padding-left:15px; margin:0;">
                                        <li><b>Pinned Memory:</b> 在 CPU 端分配锁页内存，避免 OS 分页，实现 GPU Direct DMA 高速传输。</li>
                                        <li><b>流水线并行:</b> 将计算 (Compute) 与 传输 (Transfer) 重叠，在计算 Layer N 的同时预取 Layer N+1 的 KV。</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.infra}"><i class="fa-solid fa-filter"></i> 更新与驱逐 (Policy)</div>
                                <div class="card-body">
                                    <ul style="padding-left:15px; margin:0;">
                                        <li><b>LRU 驱逐:</b> 优先换出最久未使用的 Block。</li>
                                        <li><b>预测性预取:</b> 监听 "User Typing" 事件，提前触发 Swap In，掩盖 PCIe 延迟。</li>
                                        <li><b>稀疏卸载:</b> 仅卸载 Attention Score 较低的非关键 Token (需模型支持)。</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card challenge-card" style="border-color:${C.infra}; background-color:#fffbeb;">
                                <div class="card-title" style="color:${C.infra}"><i class="fa-solid fa-crosshairs"></i> 适用场景 (Scenarios)</div>
                                <div class="card-body">
                                    <ul style="padding-left:15px; margin:0;">
                                        <li><b>✅ 适用:</b> 超长上下文 (128k+)、多轮对话中用户思考时间长、并发突发高。</li>
                                        <li><b>❌ 不适用:</b> 对延迟极其敏感的高频短对话 (PCIe 延迟不可忽略)。</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },
            {
                id: 'paged',
                group: '4. 基础设施层',
                title: 'PagedAttention 内存分页',
                meta: '非连续显存管理',
                color: C.infra,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">Virtual Memory Mapping</div>
                            <svg width="800" height="280" viewBox="0 0 800 280">
                                ${defs}
                                <!-- Logical KV -->
                                <g transform="translate(50, 60)">
                                    <text x="50" y="-10" text-anchor="middle" font-weight="bold">逻辑 KV</text>
                                    <rect x="0" y="0" width="100" height="160" fill="#fff" stroke="${C.text}"/>
                                    <rect x="0" y="0" width="100" height="40" fill="#fef3c7" stroke="${C.infra}"/>
                                    <text x="50" y="25" text-anchor="middle" font-size="10">Block 0</text>
                                    <rect x="0" y="40" width="100" height="40" fill="#fef3c7" stroke="${C.infra}"/>
                                    <text x="50" y="65" text-anchor="middle" font-size="10">Block 1</text>
                                    <rect x="0" y="80" width="100" height="40" fill="#fef3c7" stroke="${C.infra}"/>
                                    <text x="50" y="105" text-anchor="middle" font-size="10">Block 2</text>
                                </g>

                                <!-- Arrow -->
                                <line x1="160" y1="140" x2="220" y2="140" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>

                                <!-- Table -->
                                <g transform="translate(230, 80)">
                                    <text x="60" y="-10" text-anchor="middle" font-weight="bold">页表 (Block Table)</text>
                                    <rect x="0" y="0" width="120" height="120" fill="#fff" stroke="${C.infra}" stroke-width="2"/>
                                    <text x="60" y="30" text-anchor="middle" font-family="monospace" font-size="12">0 -> 0x4A</text>
                                    <text x="60" y="50" text-anchor="middle" font-family="monospace" font-size="12">1 -> 0x1C</text>
                                    <text x="60" y="70" text-anchor="middle" font-family="monospace" font-size="12">2 -> 0x8B</text>
                                </g>

                                <!-- Arrow -->
                                <line x1="360" y1="140" x2="420" y2="140" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>

                                <!-- Physical -->
                                <g transform="translate(430, 40)">
                                    <text x="100" y="-10" text-anchor="middle" font-weight="bold">物理显存 (不连续)</text>
                                    <rect x="0" y="0" width="200" height="200" fill="#f8fafc" stroke="${C.text}"/>
                                    <!-- Scattered Blocks -->
                                    <rect x="20" y="20" width="60" height="30" fill="#fef3c7" stroke="${C.infra}"/>
                                    <text x="50" y="40" text-anchor="middle" font-size="10">0x4A (B0)</text>

                                    <rect x="120" y="80" width="60" height="30" fill="#fef3c7" stroke="${C.infra}"/>
                                    <text x="150" y="100" text-anchor="middle" font-size="10">0x1C (B1)</text>

                                    <rect x="40" y="150" width="60" height="30" fill="#fef3c7" stroke="${C.infra}"/>
                                    <text x="70" y="170" text-anchor="middle" font-size="10">0x8B (B2)</text>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card">
                                <div class="card-title" style="color:${C.infra}"><i class="fa-solid fa-book"></i> 原理 (Principle)</div>
                                <div class="card-body">
                                    借鉴操作系统的虚拟内存分页技术。将连续的逻辑 KV Cache 离散存储在非连续的物理显存块 (Block) 中，消除内存碎片。
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.infra}"><i class="fa-solid fa-desktop"></i> 实例 (Example)</div>
                                <div class="card-body">
                                    vLLM 的基石技术。它将显存利用率从 <50% 提升到了接近 100%，从而支持了更大的 Batch Size 和吞吐量。
                                </div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title"><i class="fa-solid fa-triangle-exclamation"></i> 挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol style="padding-left:20px; margin:0;">
                                        <li><b>Kernel 复杂度：</b>所有 Attention 算子都必须重写以支持非连续内存访问，开发难度极大。</li>
                                        <li><b>Block Size 调优：</b>块太小导致元数据开销大，块太大导致尾部碎片浪费。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // --- NEXT GEN: RUBIN & FUTURE ---
            {
                id: 'next-gen',
                group: '5. 未来展望',
                title: '下一代演进：Rubin 架构与 Agent-Native',
                meta: 'Hardware-Software Co-Design',
                color: C.network, 
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">软硬协同演进图谱 (Co-Evolution Pillars)</div>
                            <svg width="800" height="280" viewBox="0 0 800 280">
                                ${defs}
                                
                                <!-- Background Layer -->
                                <rect x="30" y="30" width="740" height="220" fill="#fff" stroke="${C.network}" stroke-width="1" rx="8" stroke-dasharray="4"/>
                                <text x="400" y="20" text-anchor="middle" font-weight="bold" fill="${C.network}" font-size="12">Next-Gen Agent Infrastructure</text>

                                <!-- Pillar 1: Memory (Left) -->
                                <g transform="translate(60, 60)">
                                    <text x="100" y="-10" text-anchor="middle" font-weight="bold" fill="${C.prefill}">1. 内存革命</text>
                                    
                                    <!-- Top: Software -->
                                    <rect x="0" y="0" width="200" height="60" rx="4" fill="#eff6ff" stroke="${C.prefill}" stroke-width="2"/>
                                    <text x="100" y="25" text-anchor="middle" font-weight="bold" fill="${C.prefill}" font-size="11">无限上下文 (Infinite Context)</text>
                                    <text x="100" y="45" text-anchor="middle" font-size="9" fill="${C.sub}">Ring Attention / Compress</text>

                                    <!-- Arrow -->
                                    <path d="M 100 130 L 100 70" stroke="${C.prefill}" stroke-width="3" marker-end="url(#arrow-prefill)"/>
                                    <text x="110" y="100" font-size="9" fill="${C.sub}">Unlocks</text>

                                    <!-- Bottom: Hardware -->
                                    <rect x="0" y="130" width="200" height="40" rx="4" fill="#1e293b"/>
                                    <text x="100" y="155" text-anchor="middle" font-weight="bold" fill="#fff">Rubin: HBM4</text>
                                    <text x="210" y="155" font-size="9" fill="${C.sub}">更高带宽/堆叠</text>
                                </g>

                                <!-- Pillar 2: Interconnect (Middle) -->
                                <g transform="translate(300, 60)">
                                    <text x="100" y="-10" text-anchor="middle" font-weight="bold" fill="${C.infra}">2. 极致互联</text>

                                    <!-- Top: Software -->
                                    <rect x="0" y="0" width="200" height="60" rx="4" fill="#fffbeb" stroke="${C.infra}" stroke-width="2"/>
                                    <text x="100" y="25" text-anchor="middle" font-weight="bold" fill="${C.infra}" font-size="11">全局显存池 (Memory Fabric)</text>
                                    <text x="100" y="45" text-anchor="middle" font-size="9" fill="${C.sub}">Disaggregated KV Store</text>

                                    <!-- Arrow -->
                                    <path d="M 100 130 L 100 70" stroke="${C.infra}" stroke-width="3"/>
                                    <polygon points="100,60 95,70 105,70" fill="${C.infra}"/>

                                    <!-- Bottom: Hardware -->
                                    <rect x="0" y="130" width="200" height="40" rx="4" fill="#1e293b"/>
                                    <text x="100" y="155" text-anchor="middle" font-weight="bold" fill="#fff">NVLink 6 Switch</text>
                                    <text x="210" y="155" font-size="9" fill="${C.sub}">跨节点零拷贝</text>
                                </g>

                                <!-- Pillar 3: Compute (Right) -->
                                <g transform="translate(540, 60)">
                                    <text x="100" y="-10" text-anchor="middle" font-weight="bold" fill="${C.decode}">3. 算力爆发</text>

                                    <!-- Top: Software -->
                                    <rect x="0" y="0" width="200" height="60" rx="4" fill="#ecfdf5" stroke="${C.decode}" stroke-width="2"/>
                                    <text x="100" y="25" text-anchor="middle" font-weight="bold" fill="${C.decode}" font-size="11">System 2 慢思考</text>
                                    <text x="100" y="45" text-anchor="middle" font-size="9" fill="${C.sub}">Speculative Tree Search</text>

                                    <!-- Arrow -->
                                    <path d="M 100 130 L 100 70" stroke="${C.decode}" stroke-width="3"/>
                                    <polygon points="100,60 95,70 105,70" fill="${C.decode}"/>

                                    <!-- Bottom: Hardware -->
                                    <rect x="0" y="130" width="200" height="40" rx="4" fill="#1e293b"/>
                                    <text x="100" y="155" text-anchor="middle" font-weight="bold" fill="#fff">Native FP4 Core</text>
                                    <text x="210" y="155" font-size="9" fill="${C.sub}">2-4x 吞吐提升</text>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card">
                                <div class="card-title" style="color:${C.prefill}"><i class="fa-solid fa-hard-drive"></i> 内存墙突破 (HBM4)</div>
                                <div class="card-body">
                                    <b>硬件:</b> Rubin 搭载 HBM4，带宽与容量双重飞跃。<br>
                                    <b>软件演进:</b> 支持 <b>Ring Attention</b>，将 Context 扩展至 1M+ Token。Agent 可以“记住”整本技术手册或全部历史对话。
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.infra}"><i class="fa-solid fa-network-wired"></i> 互联墙突破 (NVLink 6)</div>
                                <div class="card-body">
                                    <b>硬件:</b> NVLink 6 提供超高带宽，使跨卡访问像访问本地显存一样快。<br>
                                    <b>软件演进:</b> <b>PD 分离架构</b> 将升级为“全局显存网络”，计算节点可无感访问远端 KV Cache。
                                </div>
                            </div>
                            <div class="card">
                                <div class="card-title" style="color:${C.decode}"><i class="fa-solid fa-microchip"></i> 算力墙突破 (FP4)</div>
                                <div class="card-body">
                                    <b>硬件:</b> 原生支持 FP4 低精度计算。<br>
                                    <b>软件演进:</b> 算力的富余将用于 <b>System 2 (o1-like)</b> 推理。Agent 不再是“单次生成”，而是通过“树状搜索”和“自我反思”来保证任务成功率。
                                </div>
                            </div>
                        </div>
                    </div>
                `
            }
        ];

        // --- Core Logic ---
        const navList = document.getElementById('navList');
        const slideContainer = document.getElementById('slideContainer');
        const pageNum = document.getElementById('pageNum'); // Get page number element
        let currentIndex = 0;

        function initNav() {
            let currentGroup = '';
            navList.innerHTML = slides.map((slide, idx) => {
                let html = '';
                if (slide.group && slide.group !== currentGroup) {
                    currentGroup = slide.group;
                    html += `<div class="nav-group-title">${currentGroup}</div>`;
                }
                
                let iconColor = 'inherit';
                if (slide.color && slide.group !== 'Intro') iconColor = slide.color;

                html += `
                    <div class="nav-item" id="nav-${idx}" onclick="window.nav(${idx})">
                        <div style="width:6px; height:6px; border-radius:50%; background:${iconColor}; opacity:0.7;"></div>
                        ${slide.title}
                    </div>
                `;
                return html;
            }).join('');
        }

        function renderSlide(idx) {
            const slide = slides[idx];
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById(`nav-${idx}`);
            if (activeNav) activeNav.classList.add('active');

            // Update Page Number
            if (pageNum) {
                pageNum.innerText = `${idx + 1} / ${slides.length}`;
            }

            let header = '';
            if (slide.group !== 'Intro') {
                header = `
                    <div class="slide-header">
                        <div class="slide-title">
                            <span style="color:${slide.color}"><i class="fa-solid fa-square"></i></span>
                            ${slide.title}
                        </div>
                        <div class="slide-meta">${slide.meta}</div>
                    </div>
                `;
            } else if (slide.id === 'lifecycle') {
                header = `
                     <div class="slide-header">
                        <div class="slide-title">${slide.title}</div>
                        <div class="slide-meta">${slide.meta}</div>
                    </div>
                `;
            } else if (slide.id === 'background') { // Update for merged slide
                 header = `
                     <div class="slide-header">
                        <div class="slide-title">${slide.title}</div>
                        <div class="slide-meta">${slide.meta}</div>
                    </div>
                `;
            }

            slideContainer.innerHTML = `${header}${slide.render()}`;
            slideContainer.style.animation = 'none';
            slideContainer.offsetHeight;
            slideContainer.style.animation = 'fadeUp 0.3s ease-out';
        }

        // 显式挂载到 window，确保 HTML 中的 onclick 可以调用
        window.nav = function(idx) {
            if (idx >= 0 && idx < slides.length) {
                currentIndex = idx;
                renderSlide(currentIndex);
            }
        };
        
        // Print All Slides Function
        window.printAllSlides = function() {
            const printContainer = document.getElementById('printContainer');
            printContainer.innerHTML = ''; // Clear previous content
            
            // Loop through all slides and render them
            slides.forEach((slide, index) => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'print-page';
                
                // Add header manually for print view since renderSlide does it dynamically
                let headerHTML = '';
                if (slide.group !== 'Intro') {
                    headerHTML = `
                        <div class="slide-header">
                            <div class="slide-title" style="color: #0f172a;">
                                <span style="color:${slide.color}"><i class="fa-solid fa-square"></i></span>
                                ${slide.title}
                            </div>
                            <div class="slide-meta" style="color: #475569;">${slide.meta || ''}</div>
                        </div>
                    `;
                } else {
                     headerHTML = `
                         <div class="slide-header">
                            <div class="slide-title" style="color: #0f172a;">${slide.title}</div>
                            <div class="slide-meta" style="color: #475569;">${slide.meta || ''}</div>
                        </div>
                    `;
                }

                // Combine header and slide content
                pageDiv.innerHTML = headerHTML + slide.render();
                printContainer.appendChild(pageDiv);
            });
            
            // Trigger browser print
            window.print();
        };

        // Init
        initNav();
        window.nav(0);

        // Keyboard support
        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown' || e.key === 'ArrowRight') window.nav(currentIndex + 1);
            else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') window.nav(currentIndex - 1);
        });

    })();
    </script>
</body>
</html>
