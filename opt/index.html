<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>面向 Agent 的 LLM 推理全栈优化</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            /* 浅色主题配色 */
            --bg-dark: #f8fafc;       
            --bg-panel: #ffffff;      
            --bg-sidebar: #f1f5f9;    
            
            --text-primary: #0f172a;  
            --text-secondary: #334155;
            --text-code: #1e293b;     

            /* 功能色系 */
            --c-gateway: #7c3aed;     /* Violet 600 */
            --c-prefill: #2563eb;     /* Blue 600 */
            --c-decode: #059669;      /* Emerald 600 */
            --c-infra: #d97706;       /* Amber 600 - Storage */
            --c-network: #6366f1;     /* Indigo 500 - Network */
            --c-danger: #dc2626;      /* Red 600 */
            --c-line: #64748b;        /* Slate 500 */
            
            --border: #cbd5e1;        
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            height: 100vh;
            width: 100vw;
            display: flex;
            overflow: hidden; /* 禁止 Body 滚动 */
        }

        /* --- Sidebar --- */
        .sidebar {
            width: 240px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1rem;
            flex-shrink: 0;
            z-index: 10;
        }

        .brand {
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 0.5rem;
        }

        .nav-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .nav-group-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #64748b;
            margin: 15px 0 5px 10px;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .nav-item {
            padding: 10px 12px;
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.2s;
            border-left: 3px solid transparent;
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(0,0,0,0.05);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: #e2e8f0;
            color: var(--text-primary);
            border-left-color: currentColor; 
            font-weight: 600;
        }

        /* --- Main Stage (PPT Slide Area) --- */
        .main-stage {
            flex: 1;
            padding: 2vh 3vw;
            display: flex;
            flex-direction: column;
            position: relative;
            background: radial-gradient(circle at top right, #f8fafc 0%, #f1f5f9 100%);
            height: 100vh;
            overflow: hidden;
        }

        .slide-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            animation: fadeUp 0.3s ease-out;
            height: 100%;
            overflow: hidden;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-header {
            margin-bottom: 1.5vh;
            border-bottom: 2px solid var(--border);
            padding-bottom: 1vh;
            flex-shrink: 0;
        }
        
        .slide-title {
            font-size: clamp(1.5rem, 3vh, 2.5rem);
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 1rem;
            letter-spacing: -0.5px;
            line-height: 1.2;
        }

        .slide-meta {
            font-family: 'JetBrains Mono', monospace;
            font-size: clamp(0.8rem, 1.5vh, 1rem);
            color: var(--text-secondary);
            margin-top: 0.5vh;
            font-weight: 500;
            opacity: 0.8;
        }

        /* --- Layout: Split Diagram & Details --- */
        .content-split {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2vh;
            min-height: 0;
        }

        /* Top: Diagram Area */
        .diagram-area {
            flex: 5;
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            min-height: 0; 
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.01);
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .diagram-badge {
            position: absolute;
            top: 10px; left: 15px;
            font-size: 0.8rem;
            padding: 4px 10px;
            background: rgba(255,255,255,0.9);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-family: monospace;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
        }

        /* SVG 自动适应容器 */
        svg {
            width: 100%;
            height: 100%;
            max-height: 100%;
            display: block;
            font-family: 'Inter', sans-serif;
        }

        /* Bottom: Details Grid */
        .details-grid {
            flex: 3;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5vw;
            min-height: 0;
        }

        .card {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 1.5vh 1.5vw;
            display: flex;
            flex-direction: column;
            transition: all 0.2s;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
            height: 100%;
        }

        .card::before {
            content: '';
            position: absolute;
            left: 0; top: 0; bottom: 0;
            width: 4px;
            background: currentColor;
        }
        
        .card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 12px -3px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: clamp(0.9rem, 1.8vh, 1.1rem);
            font-weight: 700;
            margin-bottom: 1vh;
            display: flex;
            align-items: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding-bottom: 0.5vh;
            border-bottom: 1px dashed #f1f5f9;
            flex-shrink: 0;
        }
        
        .card-body {
            font-size: clamp(0.85rem, 1.6vh, 0.95rem);
            line-height: 1.5;
            color: #334155;
            overflow-y: auto;
            flex: 1;
        }
        
        .card-body ul, .card-body ol { padding-left: 18px; margin: 0; }
        .card-body li { margin-bottom: 4px; }

        .card.challenge-card { background-color: #fff1f2; border-color: #fecaca; }
        .challenge-card::before { background: var(--c-danger); }
        .challenge-card .card-title { color: var(--c-danger); border-bottom-color: #fecaca; }

        /* --- Page Number & PDF --- */
        .page-number {
            position: absolute;
            bottom: 15px;
            right: 30px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            font-weight: bold;
            color: var(--text-secondary);
            opacity: 0.5;
            pointer-events: none;
        }

        .pdf-btn-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 4px;
            transition: opacity 0.3s;
        }
        .pdf-btn {
            border: none; background: transparent; cursor: pointer;
            padding: 8px 16px; font-size: 0.9rem; color: var(--text-primary);
            display: flex; align-items: center; gap: 8px; font-weight: 600;
            font-family: 'Inter', sans-serif; border-right: 1px solid #eee;
        }
        .pdf-btn:hover { background-color: #f8fafc; border-radius: 4px;}
        .pdf-close {
            padding: 8px 12px; color: var(--text-secondary); cursor: pointer; font-size: 1rem;
        }
        .pdf-close:hover { color: var(--c-danger); }

        /* --- PRINT STYLES --- */
        #printContainer { display: none; }

        @media print {
            .sidebar, .pdf-btn-container, #slideContainer, #pageNum { display: none !important; }
            #printContainer { display: block !important; }
            body, .main-stage { background: white; padding: 0; width: 100%; height: auto; overflow: visible; }
            .print-page {
                break-after: page;
                page-break-after: always;
                height: 100vh;
                width: 100%;
                padding: 40px;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }
            .content-split { height: 90vh; }
            .diagram-area { border: 1px solid #ccc; box-shadow: none; flex: 1; }
            .details-grid { flex: 0 0 auto; height: auto; }
            .card { break-inside: avoid; border: 1px solid #ccc; box-shadow: none; height: auto; }
        }

    </style>
</head>
<body>

    <aside class="sidebar">
        <div class="brand">
            <i class="fa-solid fa-server"></i> AgentInfra
        </div>
        <div class="nav-list" id="navList"></div>
    </aside>

    <main class="main-stage">
        <div id="pdfBtn" class="pdf-btn-container">
            <button class="pdf-btn" onclick="window.printAllSlides()">
                <i class="fa-solid fa-file-pdf"></i> 导出 PDF
            </button>
            <div class="pdf-close" onclick="document.getElementById('pdfBtn').style.display='none'">
                <i class="fa-solid fa-times"></i>
            </div>
        </div>

        <div id="slideContainer" class="slide-container"></div>
        <div id="printContainer"></div>
        <div id="pageNum" class="page-number"></div>
    </main>

    <script>
    (function() {
        const C = {
            gateway: '#7c3aed',
            prefill: '#2563eb',
            decode: '#059669',
            infra: '#d97706',
            network: '#6366f1',
            text: '#0f172a',
            sub: '#64748b',
            line: '#94a3b8',
            bg: '#ffffff',
            danger: '#dc2626'
        };

        const defs = `
            <defs>
                <marker id="arrow" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="${C.sub}" />
                </marker>
                <marker id="arrow-gateway" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="${C.gateway}" />
                </marker>
                <marker id="arrow-prefill" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="${C.prefill}" />
                </marker>
                <marker id="arrow-decode" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="${C.decode}" />
                </marker>
                 <marker id="arrow-infra" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="${C.infra}" />
                </marker>
                <filter id="dropShadow" x="-20%" y="-20%" width="140%" height="140%">
                    <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.15"/>
                </filter>
            </defs>
        `;

        const slides = [
            // 1. HOME
            {
                id: 'home',
                group: '简介',
                title: 'Agent LLM 推理全栈优化',
                render: () => `
                    <div style="height:100%; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center;">
                        <div style="font-size: 15vh; margin-bottom: 2vh; background: linear-gradient(135deg, ${C.prefill}, ${C.gateway}); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                            <i class="fa-solid fa-layer-group"></i>
                        </div>
                        <h1 style="font-size: 6vh; font-weight: 900; margin-bottom: 3vh; color: ${C.text}; letter-spacing: -1px;">
                            面向 Agent 的 LLM 推理全栈优化
                        </h1>
                        <p style="font-size: 2.5vh; color: ${C.sub}; max-width: 800px; margin-bottom: 8vh; line-height: 1.6; font-weight: 300;">
                            从网关到显存的深度架构重构<br>
                            <span style="font-size:2vh; opacity:0.8; font-weight:400;">解决长上下文 (Long Context)、多轮对话 (Multi-turn) 与 结构化输出的瓶颈</span>
                        </p>
                    </div>
                `
            },

            // 2. BACKGROUND
            {
                id: 'background',
                group: '简介',
                title: '背景：推理爆发与 Agent 负载特征',
                meta: 'Context & Trends',
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">市场与负载全景图</div>
                            <svg viewBox="0 0 900 320" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                
                                <!-- Left: Market Shift -->
                                <g transform="translate(50, 40)">
                                    <text x="80" y="-10" text-anchor="middle" font-weight="bold" font-size="16" fill="${C.text}">1. 算力结构翻转</text>
                                    
                                    <!-- 2023 -->
                                    <g transform="translate(20, 20)">
                                        <rect x="0" y="0" width="50" height="150" fill="#e2e8f0"/>
                                        <rect x="0" y="30" width="50" height="120" fill="${C.gateway}" opacity="0.6"/> 
                                        <rect x="0" y="0" width="50" height="30" fill="${C.decode}"/>
                                        <text x="25" y="170" text-anchor="middle" font-size="14" font-weight="bold">2023</text>
                                        <text x="-10" y="90" text-anchor="end" font-size="12" fill="${C.sub}">训练</text>
                                    </g>

                                    <!-- Arrow -->
                                    <path d="M 90 90 L 130 90" stroke="${C.line}" stroke-width="3" marker-end="url(#arrow)"/>

                                    <!-- 2026 -->
                                    <g transform="translate(150, 20)">
                                        <rect x="0" y="0" width="50" height="150" fill="#e2e8f0"/>
                                        <rect x="0" y="120" width="50" height="30" fill="${C.gateway}" opacity="0.6"/>
                                        <rect x="0" y="0" width="50" height="120" fill="${C.decode}"/>
                                        <text x="25" y="170" text-anchor="middle" font-size="14" font-weight="bold">2026</text>
                                        <text x="60" y="60" text-anchor="start" font-size="14" fill="${C.decode}" font-weight="bold">推理</text>
                                    </g>
                                    
                                    <text x="110" y="210" text-anchor="middle" font-size="12" fill="${C.sub}">Source: SemiAnalysis</text>
                                </g>

                                <line x1="280" y1="20" x2="280" y2="260" stroke="${C.line}" stroke-width="2" stroke-dasharray="6"/>

                                <!-- Right: Agent Workload -->
                                <g transform="translate(320, 40)">
                                    <text x="260" y="-10" text-anchor="middle" font-weight="bold" font-size="16" fill="${C.text}">2. Agent 时代的负载变迁</text>
                                    
                                    <!-- Chatbot -->
                                    <g transform="translate(50, 40)">
                                        <rect x="0" y="0" width="70" height="140" fill="#f1f5f9" stroke="${C.line}" stroke-width="2"/>
                                        <rect x="0" y="110" width="70" height="30" fill="${C.decode}"/>
                                        <text x="35" y="165" text-anchor="middle" font-size="14" font-weight="bold">Chatbot</text>
                                        <text x="35" y="185" text-anchor="middle" font-size="12" fill="${C.sub}">Memory Bound</text>
                                    </g>

                                    <!-- Arrow -->
                                    <path d="M 140 100 L 220 100" stroke="${C.text}" stroke-width="3" marker-end="url(#arrow)"/>
                                    <text x="180" y="90" text-anchor="middle" font-size="12" font-weight="bold" fill="${C.danger}">System 2</text>

                                    <!-- Agent -->
                                    <g transform="translate(250, 40)">
                                        <rect x="0" y="0" width="140" height="100" fill="${C.prefill}" stroke="${C.text}" stroke-width="2"/>
                                        <text x="70" y="55" text-anchor="middle" font-size="14" font-weight="bold" fill="#fff" writing-mode="tb">PREFILL</text>
                                        
                                        <rect x="30" y="100" width="80" height="40" fill="${C.decode}" opacity="0.9"/>
                                        <text x="70" y="125" text-anchor="middle" font-size="12" fill="#fff">Decode</text>
                                        
                                        <text x="70" y="165" text-anchor="middle" font-size="14" font-weight="bold" fill="${C.prefill}">Agent</text>
                                        <text x="70" y="185" text-anchor="middle" font-size="12" fill="${C.sub}">Compute Bound</text>
                                    </g>
                                    
                                    <g transform="translate(420, 60)">
                                        <text x="0" y="0" font-size="14" font-weight="bold" fill="${C.danger}">1 Query</text>
                                        <text x="0" y="25" font-size="14" font-weight="bold" fill="${C.danger}">⬇</text>
                                        <text x="0" y="50" font-size="14" font-weight="bold" fill="${C.danger}">100x 推理</text>
                                    </g>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color: ${C.gateway};">
                                <div class="card-title"><i class="fa-solid fa-chart-pie"></i> 经济规律 (One-to-Many)</div>
                                <div class="card-body">
                                    <b>训练是"印书"，推理是"卖书"。</b><br>
                                    模型训练是一次性投入，而推理服务需 7x24 响应。NVIDIA 数据显示，推理收入占比已达 40% (2024)，预计 2026 年将达 80%。
                                </div>
                            </div>
                            <div class="card" style="color: ${C.decode};">
                                <div class="card-title"><i class="fa-solid fa-brain"></i> System 2 思考</div>
                                <div class="card-body">
                                    以 OpenAI o1 为代表，模型通过<b>增加推理时的计算量 (Test-time Compute)</b> 来换取更高智能。Agent 的多轮 Tool Use 和 CoT 使得单次交互的计算量激增 10-100 倍。
                                </div>
                            </div>
                            <div class="card" style="color: ${C.prefill};">
                                <div class="card-title"><i class="fa-solid fa-weight-hanging"></i> 负载重心转移</div>
                                <div class="card-body">
                                    <b>传统 Chat:</b> 瓶颈在显存带宽 (Memory Bound)。<br>
                                    <b>Agent:</b> 巨型 Context 导致 <b>Prefill (预填充)</b> 占比激增。Prefill 是矩阵乘法密集型，瓶颈转向了 <b>GPU 算力 (Compute Bound)</b>。
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // 3. LIFECYCLE (Redesigned)
            {
                id: 'lifecycle',
                group: '简介',
                title: '全生命周期优化地图 (End-to-End Flow)',
                meta: 'Request Processing Pipeline',
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">全生命周期优化地图</div>
                            <svg viewBox="0 0 900 320" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                
                                <!-- 1. User Request (Input) -->
                                <g transform="translate(20, 100)">
                                    <circle cx="20" cy="20" r="20" fill="#f3e8ff" stroke="${C.gateway}" stroke-width="2"/>
                                    <text x="20" y="25" text-anchor="middle" font-size="10" font-weight="bold" fill="${C.gateway}">User</text>
                                    <path d="M 50 20 L 90 20" stroke="${C.gateway}" stroke-width="2" marker-end="url(#arrow-gateway)"/>
                                </g>

                                <!-- 2. Gateway Layer (Control Plane) -->
                                <g transform="translate(100, 40)">
                                    <rect x="0" y="0" width="160" height="140" rx="8" fill="#fcfaff" stroke="${C.gateway}" stroke-width="2"/>
                                    <text x="80" y="25" text-anchor="middle" font-weight="bold" fill="${C.gateway}" font-size="14">1. Gateway 网关层</text>
                                    
                                    <g transform="translate(10, 40)">
                                        <rect x="0" y="0" width="140" height="25" rx="4" fill="#fff" stroke="${C.gateway}"/>
                                        <text x="70" y="17" text-anchor="middle" font-size="10">意图识别 (Router)</text>
                                        
                                        <rect x="0" y="35" width="140" height="25" rx="4" fill="#fff" stroke="${C.gateway}"/>
                                        <text x="70" y="52" text-anchor="middle" font-size="10">粘性路由 (Affinity)</text>
                                        
                                        <rect x="0" y="70" width="140" height="25" rx="4" fill="#fff" stroke="${C.gateway}"/>
                                        <text x="70" y="87" text-anchor="middle" font-size="10">Prompt 压缩</text>
                                    </g>
                                </g>

                                <!-- Arrow to Compute -->
                                <path d="M 270 110 L 310 110" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>

                                <!-- 3. Compute Layer (PD Separation) -->
                                <g transform="translate(320, 20)">
                                    <!-- Prefill Cluster -->
                                    <g transform="translate(0, 20)">
                                        <rect x="0" y="0" width="160" height="140" rx="8" fill="#f0f7ff" stroke="${C.prefill}" stroke-width="2"/>
                                        <text x="80" y="25" text-anchor="middle" font-weight="bold" fill="${C.prefill}" font-size="14">2. Prefill 预填充</text>
                                        <text x="80" y="45" text-anchor="middle" font-size="10" fill="${C.sub}">(Compute Bound)</text>
                                        
                                        <g transform="translate(10, 60)">
                                            <rect x="0" y="0" width="140" height="25" rx="4" fill="#fff" stroke="${C.prefill}"/>
                                            <text x="70" y="17" text-anchor="middle" font-size="10">Radix Attention</text>
                                            <rect x="0" y="35" width="140" height="25" rx="4" fill="#fff" stroke="${C.prefill}"/>
                                            <text x="70" y="52" text-anchor="middle" font-size="10">Chunked Prefill</text>
                                        </g>
                                    </g>

                                    <!-- Transfer Arrow -->
                                    <path d="M 170 90 L 230 90" stroke="${C.network}" stroke-width="3" stroke-dasharray="4" marker-end="url(#arrow)"/>
                                    <text x="200" y="80" text-anchor="middle" font-size="10" fill="${C.network}" font-weight="bold">KV Transfer</text>

                                    <!-- Decode Cluster -->
                                    <g transform="translate(240, 20)">
                                        <rect x="0" y="0" width="160" height="140" rx="8" fill="#f0fdf4" stroke="${C.decode}" stroke-width="2"/>
                                        <text x="80" y="25" text-anchor="middle" font-weight="bold" fill="${C.decode}" font-size="14">3. Decode 解码</text>
                                        <text x="80" y="45" text-anchor="middle" font-size="10" fill="${C.sub}">(Memory Bound)</text>
                                        
                                        <g transform="translate(10, 60)">
                                            <rect x="0" y="0" width="140" height="25" rx="4" fill="#fff" stroke="${C.decode}"/>
                                            <text x="70" y="17" text-anchor="middle" font-size="10">Structured Gen</text>
                                            <rect x="0" y="35" width="140" height="25" rx="4" fill="#fff" stroke="${C.decode}"/>
                                            <text x="70" y="52" text-anchor="middle" font-size="10">Speculative</text>
                                        </g>
                                    </g>
                                </g>
                                
                                <!-- Vertical Connections -->
                                <line x1="400" y1="180" x2="400" y2="200" stroke="${C.infra}" stroke-width="2" stroke-dasharray="4"/>
                                <line x1="640" y1="180" x2="640" y2="200" stroke="${C.infra}" stroke-width="2" stroke-dasharray="4"/>

                                <!-- 4. Infrastructure Base (Bottom) -->
                                <g transform="translate(320, 200)">
                                    <rect x="0" y="0" width="400" height="80" rx="8" fill="#fffbeb" stroke="${C.infra}" stroke-width="2"/>
                                    <text x="200" y="25" text-anchor="middle" font-weight="bold" fill="${C.infra}" font-size="14">4. 统一显存互联底座 (Infrastructure)</text>
                                    
                                    <g transform="translate(20, 40)">
                                        <rect x="0" y="0" width="170" height="30" rx="4" fill="#fff" stroke="${C.infra}"/>
                                        <text x="85" y="20" text-anchor="middle" font-size="11">L4 Storage (PagedAttn/Offload)</text>
                                    </g>
                                    <g transform="translate(210, 40)">
                                        <rect x="0" y="0" width="170" height="30" rx="4" fill="#f5f3ff" stroke="${C.network}"/>
                                        <text x="85" y="20" text-anchor="middle" font-size="11">L5 Network (RDMA/NVLink)</text>
                                    </g>
                                </g>

                                <!-- Output Arrow -->
                                <path d="M 730 110 L 780 110" stroke="${C.text}" stroke-width="2" marker-end="url(#arrow)"/>
                                <circle cx="800" cy="110" r="20" fill="#fff" stroke="${C.text}" stroke-width="2"/>
                                <text x="800" y="115" text-anchor="middle" font-size="10" font-weight="bold">Reply</text>

                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color: ${C.gateway};">
                                <div class="card-title">1. 控制面 (Control Plane)</div>
                                <div class="card-body">
                                    负责流量的清洗与分发。通过<b>意图识别</b>和<b>一致性哈希</b>，确保 Request 被路由到最合适的计算节点，并最大化 Cache 命中率。
                                </div>
                            </div>
                            <div class="card" style="color: ${C.prefill};">
                                <div class="card-title">2. 计算面 (Compute Plane)</div>
                                <div class="card-body">
                                    采用 <b>PD 分离架构</b>。
                                    <br><b>Prefill:</b> 专注吞吐，处理长 Context (Radix Tree)。
                                    <br><b>Decode:</b> 专注延迟，处理 Token 生成 (Speculative)。
                                </div>
                            </div>
                            <div class="card" style="color: ${C.infra};">
                                <div class="card-title">3. 数据面 (Data Plane)</div>
                                <div class="card-body">
                                    构建统一的显存池。
                                    <br><b>Storage:</b> 通过 PagedAttention 和 Offloading 解决显存碎片和容量问题。
                                    <br><b>Network:</b> 通过 RDMA 实现跨节点的零拷贝传输。
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // 4. SMART ROUTING
            {
                id: 'smart-routing', group: '1. 网关层', title: 'Smart Routing 智能路由', meta: '基于意图的大小模型分流', color: C.gateway,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">逻辑拓扑 (Logical Topology)</div>
                            <svg viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                <rect x="50" y="120" width="100" height="60" rx="6" fill="#fff" stroke="${C.text}" stroke-dasharray="4" />
                                <text x="100" y="145" text-anchor="middle" font-size="14" fill="${C.text}">用户请求</text>
                                <text x="100" y="165" text-anchor="middle" font-size="12" fill="${C.sub}">(Query)</text>
                                <line x1="150" y1="150" x2="200" y2="150" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)" />
                                <polygon points="250,110 320,150 250,190 180,150" fill="#f3e8ff" stroke="${C.gateway}" stroke-width="2" filter="url(#dropShadow)"/>
                                <text x="250" y="145" text-anchor="middle" font-size="14" font-weight="bold" fill="${C.gateway}">BERT</text>
                                <text x="250" y="165" text-anchor="middle" font-size="12" fill="${C.gateway}">分类器</text>
                                <path d="M320 150 L360 150 L360 80 L420 80" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)" fill="none" />
                                <text x="370" y="70" font-size="12" fill="${C.sub}">简单 (分 > 0.8)</text>
                                <path d="M320 150 L360 150 L360 220 L420 220" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)" fill="none" />
                                <text x="370" y="210" font-size="12" fill="${C.sub}">复杂推理</text>
                                <rect x="420" y="50" width="160" height="60" rx="6" fill="#fff" stroke="${C.decode}" stroke-width="2" filter="url(#dropShadow)" />
                                <text x="500" y="75" text-anchor="middle" font-weight="bold" fill="${C.decode}" font-size="14">小模型</text>
                                <text x="500" y="95" text-anchor="middle" font-size="12" fill="${C.sub}">Llama-3-8B</text>
                                <rect x="420" y="190" width="160" height="60" rx="6" fill="#fff" stroke="${C.gateway}" stroke-width="2" filter="url(#dropShadow)" />
                                <text x="500" y="215" text-anchor="middle" font-weight="bold" fill="${C.gateway}" font-size="14">大模型</text>
                                <text x="500" y="235" text-anchor="middle" font-size="12" fill="${C.sub}">GPT-4 / 70B</text>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color:${C.gateway}">
                                <div class="card-title">原理 (Principle)</div>
                                <div class="card-body">在网关层部署轻量级模型作为前置分类器。通过分析 Prompt 的语义复杂度、意图类型（如闲聊 vs 编码），动态将流量分发至不同规模的推理模型。</div>
                            </div>
                            <div class="card" style="color:${C.gateway}">
                                <div class="card-title">实例 (Example)</div>
                                <div class="card-body">
                                    <ul>
                                        <li><b>Easy:</b> "将 '2024' 转为时间戳" -> 路由至 8B 模型。</li>
                                        <li><b>Hard:</b> "分析这 20 份财报的风险" -> 路由至 70B+ 模型。</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title">挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol>
                                        <li><b>路由延迟：</b>分类器必须极快（<5ms）。</li>
                                        <li><b>准确性：</b>误判会导致用户体验崩塌，需设计自动降级机制。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>`
            },
            
            // 5. CACHE AFFINITY
            {
                id: 'affinity', group: '1. 网关层', title: 'Cache Affinity 缓存亲和性', meta: '用户粘性路由', color: C.gateway,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">UML 部署视图 (Deployment View)</div>
                            <svg viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                <circle cx="80" cy="80" r="25" fill="#f3e8ff" stroke="${C.gateway}" stroke-width="2"/>
                                <text x="80" y="85" text-anchor="middle" font-size="14" font-weight="bold" fill="${C.gateway}">U1</text>
                                <circle cx="80" cy="220" r="25" fill="#fff" stroke="${C.sub}" stroke-width="2"/>
                                <text x="80" y="225" text-anchor="middle" font-size="14" font-weight="bold" fill="${C.sub}">U2</text>
                                <rect x="250" y="40" width="140" height="220" rx="8" fill="#fff" stroke="${C.text}" stroke-width="2" filter="url(#dropShadow)"/>
                                <text x="320" y="70" text-anchor="middle" font-weight="bold" font-size="16">负载均衡 (LB)</text>
                                <line x1="270" y1="100" x2="370" y2="100" stroke="${C.line}" stroke-width="1"/>
                                <text x="320" y="140" text-anchor="middle" font-size="14" fill="${C.gateway}">Map<ID, Node></text>
                                <text x="320" y="165" text-anchor="middle" font-size="12" fill="${C.sub}" font-family="monospace">Hash(User_ID)</text>
                                <path d="M110 80 L250 120" stroke="${C.gateway}" stroke-width="2" stroke-dasharray="4" marker-end="url(#arrow-gateway)"/>
                                <path d="M110 220 L250 180" stroke="${C.sub}" stroke-width="2" marker-end="url(#arrow)"/>
                                <g transform="translate(500, 50)">
                                    <rect x="0" y="0" width="180" height="90" rx="6" fill="#f3e8ff" stroke="${C.gateway}" stroke-width="2"/>
                                    <text x="15" y="25" font-weight="bold" fill="${C.gateway}" font-size="14">Worker #1</text>
                                    <rect x="15" y="40" width="150" height="40" fill="#fff" stroke="${C.gateway}" stroke-dasharray="2"/>
                                    <text x="90" y="65" text-anchor="middle" font-size="12" fill="${C.sub}">KV Cache: U1</text>
                                </g>
                                <g transform="translate(500, 170)">
                                    <rect x="0" y="0" width="180" height="90" rx="6" fill="#fff" stroke="${C.sub}" stroke-width="2"/>
                                    <text x="15" y="25" font-weight="bold" fill="${C.sub}" font-size="14">Worker #2</text>
                                    <rect x="15" y="40" width="150" height="40" fill="#fff" stroke="${C.sub}" stroke-dasharray="2"/>
                                    <text x="90" y="65" text-anchor="middle" font-size="12" fill="${C.sub}">KV Cache: U2</text>
                                </g>
                                <path d="M390 120 L500 95" stroke="${C.gateway}" stroke-width="2" marker-end="url(#arrow-gateway)"/>
                                <text x="445" y="100" text-anchor="middle" font-size="12" fill="${C.gateway}" font-weight="bold">粘性连接</text>
                                <path d="M390 180 L500 215" stroke="${C.sub}" stroke-width="2" marker-end="url(#arrow)"/>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color:${C.gateway}">
                                <div class="card-title">原理 (Principle)</div>
                                <div class="card-body">在云服务多实例场景中，负载均衡器 (LB) 维护 <b>Session Sticky (会话粘性)</b> 策略。基于 UserID 或 ConversationID 进行哈希路由，确保同一用户的连续请求总是被分发到同一台 Worker。</div>
                            </div>
                            <div class="card" style="color:${C.gateway}">
                                <div class="card-title">实例 (Example)</div>
                                <div class="card-body"><b>多轮对话：</b><br>Round 1 路由到 Worker-A，计算并缓存 Context。<br>Round 2 再次路由到 Worker-A，直接复用 KV Cache，仅需计算新增 Query，首字延迟降低 80%。</div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title">挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol>
                                        <li><b>负载倾斜：</b>若某用户是"话痨"，会导致对应 Worker 过载。需设计混合策略。</li>
                                        <li><b>扩缩容失效：</b>Worker 扩容时，Hash 环改变导致缓存大面积失效。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>`
            },

            // 6. PROMPT COMPRESSION
            {
                id: 'compression', group: '1. 网关层', title: 'Prompt Compression 提示词压缩', meta: '选择性上下文压缩', color: C.gateway,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">Token Importance Scoring & Pruning</div>
                            <svg viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                <g transform="translate(50, 130)">
                                    <text x="0" y="-50" font-weight="bold" font-size="14">1. 原始 Prompt</text>
                                    <rect x="0" y="0" width="30" height="30" fill="#e2e8f0" stroke="#94a3b8"/><text x="15" y="20" text-anchor="middle" font-size="12">The</text>
                                    <rect x="35" y="0" width="40" height="30" fill="#e2e8f0" stroke="#94a3b8"/><text x="55" y="20" text-anchor="middle" font-size="12">quick</text>
                                    <rect x="80" y="0" width="40" height="30" fill="#e2e8f0" stroke="#94a3b8"/><text x="100" y="20" text-anchor="middle" font-size="12">brown</text>
                                    <rect x="125" y="0" width="30" height="30" fill="#e2e8f0" stroke="#94a3b8"/><text x="140" y="20" text-anchor="middle" font-size="12">fox</text>
                                </g>
                                <line x1="180" y1="145" x2="230" y2="145" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)" />
                                <g transform="translate(240, 90)">
                                    <text x="0" y="-10" font-weight="bold" font-size="14">2. 重要性评分 (Perplexity)</text>
                                    <rect x="0" y="50" width="30" height="30" fill="#e2e8f0" opacity="0.3"/>
                                    <rect x="0" y="45" width="30" height="5" fill="${C.sub}"/><text x="15" y="70" text-anchor="middle" font-size="12" fill="${C.sub}">The</text>
                                    <rect x="35" y="50" width="40" height="30" fill="#f3e8ff"/>
                                    <rect x="35" y="10" width="40" height="40" fill="${C.gateway}"/><text x="55" y="70" text-anchor="middle" font-size="12" font-weight="bold">quick</text>
                                    <rect x="80" y="50" width="40" height="30" fill="#f3e8ff"/>
                                    <rect x="80" y="20" width="40" height="30" fill="${C.gateway}" opacity="0.8"/><text x="100" y="70" text-anchor="middle" font-size="12" font-weight="bold">brown</text>
                                    <rect x="125" y="50" width="30" height="30" fill="#f3e8ff"/>
                                    <rect x="125" y="10" width="30" height="40" fill="${C.gateway}"/><text x="140" y="70" text-anchor="middle" font-size="12" font-weight="bold">fox</text>
                                    <line x1="-10" y1="40" x2="180" y2="40" stroke="${C.danger}" stroke-dasharray="4"/>
                                    <text x="185" y="44" font-size="12" fill="${C.danger}">阈值</text>
                                </g>
                                <line x1="450" y1="145" x2="500" y2="145" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)" />
                                <g transform="translate(510, 130)">
                                    <text x="0" y="-50" font-weight="bold" font-size="14">3. 结果 (Pruned)</text>
                                    <rect x="0" y="0" width="40" height="30" fill="#f3e8ff" stroke="${C.gateway}"/><text x="20" y="20" text-anchor="middle" font-size="12">quick</text>
                                    <rect x="45" y="0" width="40" height="30" fill="#f3e8ff" stroke="${C.gateway}"/><text x="65" y="20" text-anchor="middle" font-size="12">brown</text>
                                    <rect x="90" y="0" width="30" height="30" fill="#f3e8ff" stroke="${C.gateway}"/><text x="105" y="20" text-anchor="middle" font-size="12">fox</text>
                                </g>
                                <g transform="translate(680, 115)">
                                    <rect x="0" y="0" width="100" height="60" rx="4" fill="#f0fdf4" stroke="${C.decode}"/>
                                    <text x="50" y="25" text-anchor="middle" font-weight="bold" fill="${C.decode}" font-size="14">3x Speedup</text>
                                    <text x="50" y="45" text-anchor="middle" fill="${C.decode}" font-size="12">Loss < 1%</text>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color:${C.gateway}">
                                <div class="card-title">原理 (Principle)</div>
                                <div class="card-body">基于信息论。使用一个小模型（如 LLMLingua）计算 Prompt 中每个 Token 的 <b>困惑度 (Perplexity)</b> 或注意力权重。保留高分 Token，剪枝掉停用词等低分 Token。</div>
                            </div>
                            <div class="card" style="color:${C.gateway}">
                                <div class="card-title">实例 (Example)</div>
                                <div class="card-body">RAG 检索回来 10 篇文档 (15k Tokens)。<br>压缩后去除冗余，变为 6k Tokens，直接塞入 8k 窗口，推理速度提升 2.5 倍。</div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title">挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol>
                                        <li><b>关键信息丢失：</b>可能误删 "not" 等改变句义的词。</li>
                                        <li><b>额外延迟：</b>压缩本身也是一次推理。只适用于 Prefill 耗时远大于压缩耗时的超长文本场景。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>`
            },

            // 7. PD SEPARATION
            {
                id: 'pd-sep', group: '2. 预填充层', title: 'PD Separation (分离架构)', meta: 'Prefill-Decode 分离', color: C.prefill,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">分离层级视图 (Layered Architecture)</div>
                            <svg viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                
                                <!-- 1. User/Router Layer (Top) -->
                                <g transform="translate(50, 40)">
                                    <rect x="0" y="0" width="700" height="40" rx="8" fill="#f3e8ff" stroke="${C.gateway}" stroke-width="2"/>
                                    <text x="350" y="25" text-anchor="middle" font-weight="bold" fill="${C.gateway}" font-size="16">用户请求入口层 (Gateway / Router)</text>
                                </g>

                                <!-- Arrows -->
                                <line x1="200" y1="70" x2="200" y2="90" stroke="${C.gateway}" stroke-width="2" marker-end="url(#arrow-gateway)"/>
                                <line x1="600" y1="70" x2="600" y2="90" stroke="${C.gateway}" stroke-width="2" marker-end="url(#arrow-gateway)"/>

                                <!-- 2. Compute Layer (Middle) -->
                                <g transform="translate(50, 90)">
                                    <!-- Prefill Cluster -->
                                    <rect x="0" y="0" width="300" height="70" rx="8" fill="#eff6ff" stroke="${C.prefill}" stroke-width="2"/>
                                    <text x="150" y="30" text-anchor="middle" font-weight="bold" fill="${C.prefill}">Prefill Cluster (高算力)</text>
                                    <text x="150" y="50" text-anchor="middle" font-size="10" fill="${C.sub}">A100/H100 Nodes</text>

                                    <!-- Decode Cluster -->
                                    <rect x="400" y="0" width="300" height="70" rx="8" fill="#ecfdf5" stroke="${C.decode}" stroke-width="2"/>
                                    <text x="550" y="30" text-anchor="middle" font-weight="bold" fill="${C.decode}">Decode Cluster (大显存)</text>
                                    <text x="550" y="50" text-anchor="middle" font-size="10" fill="${C.sub}">L20/L40 Nodes</text>
                                </g>

                                <!-- 3. Network Layer (Separate) -->
                                <g transform="translate(50, 180)">
                                    <rect x="0" y="0" width="700" height="30" rx="15" fill="#f3e8ff" stroke="${C.network}" stroke-width="2"/>
                                    <text x="350" y="20" text-anchor="middle" font-weight="bold" fill="${C.network}" font-size="11">高速网络层 (RDMA / InfiniBand / 400Gbps Fabric)</text>
                                    
                                    <!-- Connectors -->
                                    <line x1="150" y1="-20" x2="150" y2="0" stroke="${C.prefill}" stroke-width="2"/>
                                    <line x1="550" y1="-20" x2="550" y2="0" stroke="${C.decode}" stroke-width="2"/>
                                </g>

                                <!-- 4. Storage Layer (Separate) -->
                                <g transform="translate(50, 230)">
                                    <rect x="0" y="0" width="700" height="40" rx="4" fill="#fffbeb" stroke="${C.infra}" stroke-width="2"/>
                                    <text x="350" y="25" text-anchor="middle" font-weight="bold" fill="${C.infra}">存储层 (Global KV Cache Pool / HBM / DDR / NVMe)</text>
                                    
                                    <!-- Connectors -->
                                    <line x1="150" y1="-20" x2="150" y2="0" stroke="${C.infra}" stroke-width="2" stroke-dasharray="4"/>
                                    <line x1="550" y1="-20" x2="550" y2="0" stroke="${C.infra}" stroke-width="2" stroke-dasharray="4"/>
                                </g>

                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color:${C.prefill}">
                                <div class="card-title">原理 (Principle)</div>
                                <div class="card-body">将推理过程拆解。<b>Prefill 阶段</b>是计算密集型，使用高算力实例；<b>Decode 阶段</b>是访存密集型，使用高显存带宽实例。中间通过独立的高速网络层传输数据。</div>
                            </div>
                            <div class="card" style="color:${C.infra}">
                                <div class="card-title">Global KV Pool</div>
                                <div class="card-body">Prefill 计算完的 KV 不留在本地，而是直接写入目标 Decode 节点的地址空间（或共享存储），实现<b>零拷贝传输</b>与状态解耦。</div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title">挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol>
                                        <li><b>网络带宽瓶颈：</b>KV Cache 数据量极大（几百 MB 到 GB 级）。必须依赖 RDMA 等高性能网络，否则传输耗时会超过计算耗时。</li>
                                        <li><b>调度复杂性：</b>需精确管理 KV 的生命周期和跨节点状态同步。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            },

            // 8. BLOCK SPARSE
            {
                id: 'block-sparse', group: '2. 预填充层', title: 'Block Sparse Attention', meta: '长文本计算优化', color: C.prefill,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">Block-wise Computation</div>
                            <svg viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                <g transform="translate(50, 40)">
                                    <text x="75" y="-10" text-anchor="middle" font-weight="bold" fill="${C.text}" font-size="14">1. 块划分</text>
                                    <rect x="0" y="0" width="20" height="150" fill="#fff" stroke="${C.text}"/><text x="10" y="165" text-anchor="middle" font-size="12">Q</text>
                                    <text x="35" y="75" text-anchor="middle" font-size="18">×</text>
                                    <g transform="translate(50, 0)">
                                        <rect x="0" y="0" width="150" height="20" fill="#fff" stroke="${C.text}"/><text x="75" y="165" text-anchor="middle" font-size="12">Kᵀ</text>
                                        <rect x="0" y="30" width="150" height="120" fill="#f8fafc" stroke="${C.sub}" stroke-dasharray="2"/>
                                        <rect x="60" y="60" width="30" height="30" fill="${C.prefill}" fill-opacity="0.2" stroke="${C.prefill}" stroke-width="2"/>
                                        <text x="75" y="78" text-anchor="middle" font-size="11" fill="${C.prefill}">Block</text>
                                    </g>
                                </g>
                                <line x1="280" y1="100" x2="320" y2="100" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>
                                <g transform="translate(340, 40)">
                                    <text x="75" y="-10" text-anchor="middle" font-weight="bold" fill="${C.text}" font-size="14">2. 掩码判定</text>
                                    <rect x="0" y="0" width="150" height="150" fill="#fff" stroke="${C.text}"/>
                                    <rect x="0" y="0" width="30" height="150" fill="${C.gateway}" opacity="0.6"/><text x="15" y="165" text-anchor="middle" font-size="12" fill="${C.gateway}">Global</text>
                                    <text x="-5" y="10" text-anchor="end" font-size="11" fill="${C.gateway}">col < S</text>
                                    <rect x="0" y="0" width="30" height="30" fill="${C.decode}"/><rect x="30" y="30" width="30" height="30" fill="${C.decode}"/><rect x="60" y="60" width="30" height="30" fill="${C.decode}"/><rect x="90" y="90" width="30" height="30" fill="${C.decode}"/><rect x="120" y="120" width="30" height="30" fill="${C.decode}"/>
                                    <text x="160" y="140" font-size="11" fill="${C.decode}">|i-j| < W</text>
                                    <text x="100" y="50" font-size="14" fill="${C.sub}" opacity="0.5">0</text>
                                </g>
                                <line x1="510" y1="100" x2="550" y2="100" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>
                                <g transform="translate(570, 60)">
                                    <text x="80" y="-30" text-anchor="middle" font-weight="bold" fill="${C.text}" font-size="14">3. 稀疏计算</text>
                                    <rect x="0" y="0" width="180" height="110" rx="8" fill="#f0fdf4" stroke="${C.decode}"/>
                                    <text x="90" y="20" text-anchor="middle" font-weight="bold" font-size="12" fill="${C.decode}">GPU Tensor Core</text>
                                    <g transform="translate(20, 40)">
                                        <text x="0" y="0" font-family="monospace" font-size="11">for block(i,j):</text>
                                        <text x="10" y="15" font-family="monospace" font-size="11" fill="${C.danger}">if mask == 0: skip</text>
                                        <text x="10" y="30" font-family="monospace" font-size="11">else:</text>
                                        <text x="20" y="45" font-family="monospace" font-size="11">load & multiply</text>
                                    </g>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color:${C.prefill}">
                                <div class="card-title">掩码逻辑 (Logic)</div>
                                <div class="card-body">对 BxB 的块，仅保留满足条件的：<br><b>Local:</b> 对角线附近 (滑动窗口)<br><b>Global:</b> 全局锚点 (System Prompt)<br><b>Random:</b> 少量随机块</div>
                            </div>
                            <div class="card" style="color:${C.prefill}">
                                <div class="card-title">计算流 (Pipeline)</div>
                                <div class="card-body">GPU Kernel 优化：<br>1. <b>Skip:</b> 读取 Mask，为 0 直接跳过。<br>2. <b>Load:</b> 仅加载有效块到 SRAM。<br>3. <b>MMA:</b> Tensor Core 计算。</div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title">挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol>
                                        <li><b>负载均衡：</b>每行非零块数量不同，导致 GPU 线程空闲。</li>
                                        <li><b>精度恢复：</b>需微调以适应长程信息丢失。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>`
            },

            // 9. RADIX ATTENTION
            {
                id: 'radix', group: '2. 预填充层', title: 'Radix Attention (前缀树)', meta: 'KV Cache 复用', color: C.prefill,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">Radix Tree Structure</div>
                            <svg viewBox="0 0 800 280" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                <g transform="translate(300, 20)">
                                    <rect x="0" y="0" width="200" height="60" rx="4" fill="#eff6ff" stroke="${C.prefill}" stroke-width="2"/>
                                    <text x="100" y="25" text-anchor="middle" font-weight="bold" fill="${C.prefill}" font-size="14">根节点: System Prompt</text>
                                    <text x="100" y="45" text-anchor="middle" font-size="12" fill="${C.sub}" font-family="monospace">"You are..."</text>
                                </g>
                                <path d="M400 80 L200 130" stroke="${C.line}" stroke-width="2" />
                                <path d="M400 80 L600 130" stroke="${C.line}" stroke-width="2" />
                                <g transform="translate(100, 130)">
                                    <rect x="0" y="0" width="200" height="60" rx="4" fill="#fff" stroke="${C.sub}" stroke-width="2"/>
                                    <text x="100" y="25" text-anchor="middle" font-weight="bold" fill="${C.text}" font-size="14">用户 A 历史</text>
                                    <text x="100" y="45" text-anchor="middle" font-size="12" fill="${C.sub}" font-family="monospace">"Analyze PDF"</text>
                                    <text x="180" y="75" font-size="14" fill="${C.decode}" font-weight="bold">Hit!</text>
                                </g>
                                <g transform="translate(500, 130)">
                                    <rect x="0" y="0" width="200" height="60" rx="4" fill="#fff" stroke="${C.sub}" stroke-width="2" stroke-dasharray="4"/>
                                    <text x="100" y="25" text-anchor="middle" font-weight="bold" fill="${C.sub}" font-size="14">用户 B 历史</text>
                                    <text x="100" y="45" text-anchor="middle" font-size="12" fill="${C.sub}" font-family="monospace">"Snake Game"</text>
                                    <text x="180" y="75" font-size="14" fill="${C.sub}">Cold</text>
                                </g>
                                <path d="M200 190 L200 220" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>
                                <g transform="translate(120, 220)">
                                    <rect x="0" y="0" width="160" height="40" rx="4" fill="#ecfdf5" stroke="${C.decode}" stroke-width="2"/>
                                    <text x="80" y="25" text-anchor="middle" font-weight="bold" fill="${C.decode}" font-size="14">新请求 Query</text>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color:${C.prefill}">
                                <div class="card-title">原理 (Principle)</div>
                                <div class="card-body">将 KV Cache 维护为一棵<b>基数树 (Radix Tree)</b>。树的节点代表 Token 序列片段。当新请求的前缀（如 System Prompt + 历史对话）与树中路径匹配时，直接映射物理显存。</div>
                            </div>
                            <div class="card" style="color:${C.prefill}">
                                <div class="card-title">实例 (Example)</div>
                                <div class="card-body"><b>多轮对话：</b>用户追问时，系统识别到前缀 "解释量子力学" 已存在，直接复用 Cache，仅需计算新增 Token，<b>Prefill 耗时接近 0ms</b>。</div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title">挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol>
                                        <li><b>前缀敏感：</b>Prompt 头部若有随机 ID，会导致无法匹配根节点。</li>
                                        <li><b>驱逐策略：</b>树形结构的 LRU 驱逐需维护父子引用关系。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>`
            },

            // 10. CHUNKED PREFILL
            {
                id: 'chunked', group: '2. 预填充层', title: 'Chunked Prefill (分块预填充)', meta: 'GPU 调度优化', color: C.prefill,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">GPU Timeline Comparison</div>
                            <svg viewBox="0 0 800 280" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                <line x1="50" y1="200" x2="750" y2="200" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>
                                <text x="750" y="225" text-anchor="end" font-size="14" fill="${C.sub}">时间</text>
                                
                                <text x="50" y="50" font-weight="bold" fill="${C.text}" font-size="16">🔴 传统模式 (无分块)</text>
                                <rect x="50" y="60" width="400" height="40" fill="#dbeafe" stroke="${C.prefill}"/>
                                <text x="250" y="85" text-anchor="middle" fill="${C.prefill}" font-size="14">超长 Prefill (2s)</text>
                                <rect x="460" y="60" width="50" height="40" fill="#f0fdf4" stroke="${C.decode}"/>
                                <text x="485" y="85" text-anchor="middle" fill="${C.decode}" font-size="12">Decode</text>
                                <text x="485" y="120" text-anchor="middle" fill="${C.danger}" font-size="12">被阻塞!</text>
                                
                                <text x="50" y="140" font-weight="bold" fill="${C.text}" font-size="16">🟢 Chunked Prefill (分块)</text>
                                <rect x="50" y="150" width="100" height="40" fill="#dbeafe" stroke="${C.prefill}"/>
                                <text x="100" y="175" text-anchor="middle" fill="${C.prefill}" font-size="12">Chunk 1</text>
                                <rect x="155" y="150" width="50" height="40" fill="#f0fdf4" stroke="${C.decode}"/>
                                <text x="180" y="175" text-anchor="middle" fill="${C.decode}" font-size="12">Dec A</text>
                                <rect x="210" y="150" width="100" height="40" fill="#dbeafe" stroke="${C.prefill}"/>
                                <text x="260" y="175" text-anchor="middle" fill="${C.prefill}" font-size="12">Chunk 2</text>
                                <rect x="315" y="150" width="50" height="40" fill="#f0fdf4" stroke="${C.decode}"/>
                                <text x="340" y="175" text-anchor="middle" fill="${C.decode}" font-size="12">Dec B</text>
                                <rect x="370" y="150" width="100" height="40" fill="#dbeafe" stroke="${C.prefill}"/>
                                <text x="420" y="175" text-anchor="middle" fill="${C.prefill}" font-size="12">Chunk 3</text>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color:${C.prefill}">
                                <div class="card-title">原理 (Principle)</div>
                                <div class="card-body">将超长的 Prefill 任务切分成多个小块 (Chunk)。在 GPU 执行完一个 Chunk 后，调度器有机会插入处理其他高优先级的 Decode 任务。</div>
                            </div>
                            <div class="card" style="color:${C.prefill}">
                                <div class="card-title">实例 (Example)</div>
                                <div class="card-body"><b>混合负载：</b>长文档解析（长）+ 实时聊天（短）。<br>系统在处理文档的间隙快速响应聊天请求，消除卡顿。</div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title">挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol>
                                        <li><b>KV 状态开销：</b>频繁切换任务需要保存/恢复 KV。</li>
                                        <li><b>总耗时：</b>虽然优化了延迟，但长任务的总完成时间会略微增加。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>`
            },

            // 11. STRUCTURED GEN
            {
                id: 'struct-gen', group: '3. 解码层', title: 'Structured Gen 结构化生成', meta: 'JSON Schema 约束', color: C.decode,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">Trie-FSM 采样掩码</div>
                            <svg viewBox="0 0 800 300" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                <g transform="translate(30, 40)">
                                    <text x="0" y="20" font-weight="bold" font-size="14" fill="${C.text}">当前状态:</text>
                                    <rect x="0" y="30" width="160" height="60" rx="4" fill="#fff" stroke="${C.text}" stroke-width="1"/>
                                    <text x="10" y="55" font-family="monospace" font-size="14">"mode": <tspan fill="${C.decode}" font-weight="bold">"s_</tspan></text>
                                    <text x="10" y="80" font-family="monospace" font-size="12" fill="${C.sub}">(Schema: "safe" | "speed")</text>
                                </g>
                                <line x1="170" y1="60" x2="210" y2="60" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>
                                <g transform="translate(220, 20)">
                                    <rect x="0" y="0" width="240" height="200" rx="8" fill="#f0fdf4" stroke="${C.decode}" stroke-width="2"/>
                                    <text x="120" y="25" text-anchor="middle" font-weight="bold" fill="${C.decode}" font-size="16">Trie FSM</text>
                                    <circle cx="40" cy="100" r="15" fill="#fff" stroke="${C.decode}"/><text x="40" y="104" text-anchor="middle" font-size="12">Start</text>
                                    <path d="M 55 100 L 95 100" stroke="${C.decode}" stroke-width="2" marker-end="url(#arrow)"/>
                                    <circle cx="110" cy="100" r="15" fill="#d1fae5" stroke="${C.decode}" stroke-width="3"/><text x="110" y="104" text-anchor="middle" font-size="14" font-weight="bold">s</text>
                                    <path d="M 120 90 L 160 60" stroke="${C.decode}" stroke-width="1" stroke-dasharray="2"/><circle cx="170" cy="55" r="12" fill="#fff" stroke="${C.decode}"/><text x="170" y="59" text-anchor="middle" font-size="12">a</text>
                                    <path d="M 120 110 L 160 140" stroke="${C.decode}" stroke-width="1" stroke-dasharray="2"/><circle cx="170" cy="145" r="12" fill="#fff" stroke="${C.decode}"/><text x="170" y="149" text-anchor="middle" font-size="12">p</text>
                                    <text x="120" y="185" text-anchor="middle" font-size="14" font-weight="bold" fill="${C.decode}">Next: {'a', 'p'}</text>
                                </g>
                                <line x1="470" y1="120" x2="510" y2="120" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>
                                <g transform="translate(520, 20)">
                                    <text x="100" y="15" text-anchor="middle" font-weight="bold" fill="${C.text}" font-size="16">Logit Masking</text>
                                    <g transform="translate(20, 30)">
                                        <rect x="0" y="0" width="160" height="25" fill="#d1fae5" stroke="${C.decode}"/><text x="10" y="17" font-family="monospace" font-size="14">"a"</text><text x="130" y="17" font-size="14" fill="${C.decode}" font-weight="bold">OK</text>
                                        <rect x="0" y="30" width="160" height="25" fill="#fee2e2" stroke="${C.danger}"/><text x="10" y="47" font-family="monospace" font-size="14">"b"</text><text x="100" y="47" font-size="12" fill="${C.danger}">Mask (-inf)</text>
                                        <rect x="0" y="60" width="160" height="25" fill="#d1fae5" stroke="${C.decode}"/><text x="10" y="77" font-family="monospace" font-size="14">"p"</text><text x="130" y="77" font-size="14" fill="${C.decode}" font-weight="bold">OK</text>
                                        <rect x="0" y="90" width="160" height="25" fill="#fee2e2" stroke="${C.danger}"/><text x="10" y="107" font-family="monospace" font-size="14">"s"</text><text x="100" y="107" font-size="12" fill="${C.danger}">Mask (-inf)</text>
                                    </g>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color:${C.decode}">
                                <div class="card-title">原理 (Principle)</div>
                                <div class="card-body">将 JSON Schema 编译为 <b>Trie</b> 或 <b>PDA</b>。在生成时，根据当前状态计算合法的下一跳字符集合，构建掩码。</div>
                            </div>
                            <div class="card" style="color:${C.decode}">
                                <div class="card-title">实例 (Example)</div>
                                <div class="card-body">Schema: Enum["safe", "speed"]。前缀 "s"。FSM 允许 'a' 或 'p'。Mask 掉其他 50k+ Tokens。</div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title">挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol>
                                        <li><b>Token 歧义：</b>需处理 "safe" vs "sa"+"fe" 的子词匹配。</li>
                                        <li><b>动态 Schema：</b>递归结构需动态构建 FSM。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>`
            },

            // 12. SPECULATIVE DECODING
            {
                id: 'speculative', group: '3. 解码层', title: 'Speculative Decoding 投机采样', meta: 'Draft & Verify 机制', color: C.decode,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">Context: "The cat is on"</div>
                            <svg viewBox="0 0 800 280" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                <g transform="translate(20, 80)">
                                    <text x="60" y="-10" text-anchor="middle" font-weight="bold" fill="${C.sub}" font-size="14">Draft Model</text>
                                    <rect x="0" y="0" width="120" height="70" rx="4" fill="#f0fdf4" stroke="${C.decode}" stroke-dasharray="4"/>
                                    <text x="60" y="20" text-anchor="middle" fill="${C.decode}" font-size="14">生成 4 Tokens</text>
                                    <g transform="translate(10, 35)">
                                        <rect x="0" y="0" width="22" height="20" fill="#fff" stroke="${C.decode}"/><text x="11" y="14" text-anchor="middle" font-size="11">the</text>
                                        <rect x="25" y="0" width="22" height="20" fill="#fff" stroke="${C.decode}"/><text x="36" y="14" text-anchor="middle" font-size="11">mat</text>
                                        <rect x="50" y="0" width="22" height="20" fill="#fff" stroke="${C.decode}"/><text x="61" y="14" text-anchor="middle" font-size="10">sleep</text>
                                        <rect x="75" y="0" width="22" height="20" fill="#fff" stroke="${C.decode}"/><text x="86" y="14" text-anchor="middle" font-size="11">now</text>
                                    </g>
                                </g>
                                <line x1="140" y1="115" x2="170" y2="115" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>
                                <g transform="translate(180, 70)">
                                    <rect x="0" y="0" width="90" height="90" fill="#f8fafc" stroke="${C.line}" stroke-width="1"/>
                                    <text x="45" y="-10" text-anchor="middle" font-size="14" fill="${C.sub}">Input Matrix</text>
                                    <g transform="translate(15, 15)">
                                        <rect x="0" y="0" width="60" height="12" fill="#e2e8f0"/><text x="30" y="9" text-anchor="middle" font-size="10" font-family="monospace">..on the</text>
                                        <rect x="0" y="15" width="60" height="12" fill="#e2e8f0"/><text x="30" y="24" text-anchor="middle" font-size="10" font-family="monospace">..on the mat</text>
                                        <rect x="0" y="30" width="60" height="12" fill="#e2e8f0"/><text x="30" y="39" text-anchor="middle" font-size="10" font-family="monospace">..mat sleep</text>
                                    </g>
                                </g>
                                <line x1="270" y1="115" x2="300" y2="115" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>
                                <g transform="translate(310, 40)">
                                    <rect x="0" y="0" width="340" height="160" rx="8" fill="#fff" stroke="${C.decode}" stroke-width="2"/>
                                    <text x="170" y="20" text-anchor="middle" font-weight="bold" fill="${C.decode}" font-size="16">Target Model</text>
                                    <text x="170" y="38" text-anchor="middle" font-size="12" fill="${C.sub}">一次 Forward Pass (并行评分)</text>
                                    <g transform="translate(20, 60)">
                                        <circle cx="10" cy="10" r="8" fill="#d1fae5"/><text x="10" y="14" text-anchor="middle" fill="${C.decode}" font-size="12">✓</text>
                                        <circle cx="35" cy="10" r="8" fill="#d1fae5"/><text x="35" y="14" text-anchor="middle" fill="${C.decode}" font-size="12">✓</text>
                                        <circle cx="62" cy="10" r="8" fill="#d1fae5"/><text x="62" y="14" text-anchor="middle" fill="${C.decode}" font-size="12">✓</text>
                                        <circle cx="90" cy="10" r="8" fill="#fee2e2"/><text x="90" y="14" text-anchor="middle" fill="${C.danger}" font-size="12">✗</text>
                                        <text x="140" y="14" font-size="12" fill="${C.sub}">拒绝 "now"</text>
                                        <text x="140" y="28" font-size="12" fill="${C.decode}" font-weight="bold">重采样: "sound"</text>
                                    </g>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color:${C.decode}">
                                <div class="card-title">原理 (Principle)</div>
                                <div class="card-body"><b>Draft-Verify:</b> 小模型串行生成 N 个 Token，大模型进行<b>一次 Forward Pass</b> 并行验证。</div>
                            </div>
                            <div class="card" style="color:${C.decode}">
                                <div class="card-title">实例 (Example)</div>
                                <div class="card-body"><b>Draft:</b> "the", "mat", "sleep", "now"<br><b>Target:</b> 接受前3个，拒绝"now"。一次推理生成 3 个有效 Token。</div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title">挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol>
                                        <li><b>模型对齐：</b>Draft 分布需接近 Target，否则拒绝率高。</li>
                                        <li><b>动态调整：</b>高熵（难）任务需自动关闭投机。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>`
            },

            // 13. OFF-LOADING
            {
                id: 'offload', group: '4. 基础设施层', title: 'KV Offloading 分级存储', meta: 'Swap In/Out 机制', color: C.infra,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">Memory Hierarchy & Data Flow</div>
                            <svg viewBox="0 0 800 280" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                <g transform="translate(100, 40)">
                                    <rect x="0" y="0" width="160" height="200" rx="8" fill="#fffbeb" stroke="${C.infra}" stroke-width="2"/>
                                    <text x="80" y="30" text-anchor="middle" font-weight="bold" fill="${C.infra}" font-size="16">GPU VRAM</text>
                                    <text x="80" y="50" text-anchor="middle" font-size="12" fill="${C.sub}">HBM3 (Active)</text>
                                    <rect x="20" y="70" width="120" height="20" fill="${C.infra}" opacity="0.9"/>
                                    <rect x="20" y="95" width="120" height="20" fill="${C.infra}" opacity="0.9"/>
                                    <rect x="20" y="120" width="120" height="20" fill="#fff" stroke="${C.infra}" stroke-dasharray="2"/>
                                    <text x="80" y="135" text-anchor="middle" font-size="12" fill="${C.sub}">Swap Victim</text>
                                </g>
                                <g transform="translate(300, 120)">
                                    <line x1="0" y1="0" x2="200" y2="0" stroke="${C.text}" stroke-width="4"/>
                                    <text x="100" y="-15" text-anchor="middle" font-size="14" font-weight="bold">PCIe Gen5 x16</text>
                                    <path d="M50 10 L150 10" stroke="${C.sub}" marker-end="url(#arrow)"/>
                                    <text x="100" y="25" text-anchor="middle" font-size="12">Evict</text>
                                    <path d="M150 40 L50 40" stroke="${C.sub}" marker-end="url(#arrow)"/>
                                    <text x="100" y="55" text-anchor="middle" font-size="12">Prefetch</text>
                                </g>
                                <g transform="translate(540, 40)">
                                    <rect x="0" y="0" width="160" height="200" rx="8" fill="#f8fafc" stroke="${C.text}" stroke-width="2"/>
                                    <text x="80" y="30" text-anchor="middle" font-weight="bold" fill="${C.text}" font-size="16">CPU Memory</text>
                                    <text x="80" y="50" text-anchor="middle" font-size="12" fill="${C.sub}">Pinned DRAM</text>
                                    <rect x="20" y="70" width="120" height="20" fill="${C.sub}" opacity="0.2"/>
                                    <rect x="20" y="95" width="120" height="20" fill="${C.sub}" opacity="0.2"/>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color:${C.infra}">
                                <div class="card-title">核心技术 (Details)</div>
                                <div class="card-body">
                                    <ul>
                                        <li><b>Pinned Memory:</b> CPU 锁页内存，实现 GPU Direct DMA。</li>
                                        <li><b>流水线:</b> 计算与传输重叠，掩盖延迟。</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card" style="color:${C.infra}">
                                <div class="card-title">策略 (Policy)</div>
                                <div class="card-body">
                                    <ul>
                                        <li><b>LRU 驱逐:</b> 优先换出最久未使用。</li>
                                        <li><b>预测性预取:</b> 监听 "Typing" 事件，提前 Swap In。</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title">适用场景 (Scenarios)</div>
                                <div class="card-body">
                                    <ul>
                                        <li><b>✅ 适用:</b> 超长上下文、长思考时间。</li>
                                        <li><b>❌ 不适用:</b> 高频低延时短对话。</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>`
            },
            
            // 14. PAGED ATTENTION (Moved to be next to Offloading for logical grouping in infra)
            {
                id: 'paged', group: '4. 基础设施层', title: 'PagedAttention 内存分页', meta: '非连续显存管理', color: C.infra,
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">Virtual Memory Mapping</div>
                            <svg viewBox="0 0 800 280" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                <g transform="translate(50, 60)">
                                    <text x="50" y="-10" text-anchor="middle" font-weight="bold">逻辑 KV</text>
                                    <rect x="0" y="0" width="100" height="160" fill="#fff" stroke="${C.text}"/>
                                    <rect x="0" y="0" width="100" height="40" fill="#fef3c7" stroke="${C.infra}"/>
                                    <text x="50" y="25" text-anchor="middle" font-size="10">Block 0</text>
                                    <rect x="0" y="40" width="100" height="40" fill="#fef3c7" stroke="${C.infra}"/>
                                    <text x="50" y="65" text-anchor="middle" font-size="10">Block 1</text>
                                    <rect x="0" y="80" width="100" height="40" fill="#fef3c7" stroke="${C.infra}"/>
                                    <text x="50" y="105" text-anchor="middle" font-size="10">Block 2</text>
                                </g>
                                <line x1="160" y1="140" x2="220" y2="140" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>
                                <g transform="translate(230, 80)">
                                    <text x="60" y="-10" text-anchor="middle" font-weight="bold">页表 (Block Table)</text>
                                    <rect x="0" y="0" width="120" height="120" fill="#fff" stroke="${C.infra}" stroke-width="2"/>
                                    <text x="60" y="30" text-anchor="middle" font-family="monospace" font-size="12">0 -> 0x4A</text>
                                    <text x="60" y="50" text-anchor="middle" font-family="monospace" font-size="12">1 -> 0x1C</text>
                                    <text x="60" y="70" text-anchor="middle" font-family="monospace" font-size="12">2 -> 0x8B</text>
                                </g>
                                <line x1="360" y1="140" x2="420" y2="140" stroke="${C.line}" stroke-width="2" marker-end="url(#arrow)"/>
                                <g transform="translate(430, 40)">
                                    <text x="100" y="-10" text-anchor="middle" font-weight="bold">物理显存 (不连续)</text>
                                    <rect x="0" y="0" width="200" height="200" fill="#f8fafc" stroke="${C.text}"/>
                                    <rect x="20" y="20" width="60" height="30" fill="#fef3c7" stroke="${C.infra}"/>
                                    <text x="50" y="40" text-anchor="middle" font-size="10">0x4A (B0)</text>
                                    <rect x="120" y="80" width="60" height="30" fill="#fef3c7" stroke="${C.infra}"/>
                                    <text x="150" y="100" text-anchor="middle" font-size="10">0x1C (B1)</text>
                                    <rect x="40" y="150" width="60" height="30" fill="#fef3c7" stroke="${C.infra}"/>
                                    <text x="70" y="170" text-anchor="middle" font-size="10">0x8B (B2)</text>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color:${C.infra}">
                                <div class="card-title">原理 (Principle)</div>
                                <div class="card-body">借鉴操作系统的虚拟内存分页技术。将连续的逻辑 KV Cache 离散存储在非连续的物理显存块 (Block) 中，消除内存碎片。</div>
                            </div>
                            <div class="card" style="color:${C.infra}">
                                <div class="card-title">实例 (Example)</div>
                                <div class="card-body">vLLM 的基石技术。它将显存利用率从 <50% 提升到了接近 100%，从而支持了更大的 Batch Size 和吞吐量。</div>
                            </div>
                            <div class="card challenge-card">
                                <div class="card-title">挑战 (Challenges)</div>
                                <div class="card-body">
                                    <ol>
                                        <li><b>Kernel 复杂度：</b>所有 Attention 算子都必须重写以支持非连续内存访问，开发难度极大。</li>
                                        <li><b>Block Size 调优：</b>块太小导致元数据开销大，块太大导致尾部碎片浪费。</li>
                                    </ol>
                                </div>
                            </div>
                        </div>
                    </div>`
            },

            // 15. NEXT GEN
            {
                id: 'next-gen', group: '5. 未来展望', title: '下一代演进：Rubin 架构与 Agent-Native', meta: 'Hardware-Software Co-Design', color: C.network, 
                render: () => `
                    <div class="content-split">
                        <div class="diagram-area">
                            <div class="diagram-badge">软硬协同演进图谱 (Three Pillars)</div>
                            <svg viewBox="0 0 800 280" preserveAspectRatio="xMidYMid meet">
                                ${defs}
                                <rect x="30" y="30" width="740" height="220" fill="#fff" stroke="${C.network}" stroke-width="1" rx="8" stroke-dasharray="4"/>
                                <g transform="translate(60, 60)">
                                    <text x="100" y="-10" text-anchor="middle" font-weight="bold" fill="${C.prefill}" font-size="16">1. 内存革命</text>
                                    <rect x="0" y="0" width="200" height="60" rx="4" fill="#eff6ff" stroke="${C.prefill}" stroke-width="2"/>
                                    <text x="100" y="25" text-anchor="middle" font-weight="bold" fill="${C.prefill}" font-size="12">无限上下文</text>
                                    <text x="100" y="45" text-anchor="middle" font-size="11" fill="${C.sub}">Ring Attention</text>
                                    <path d="M 100 130 L 100 70" stroke="${C.prefill}" stroke-width="3" marker-end="url(#arrow-prefill)"/>
                                    <rect x="0" y="130" width="200" height="40" rx="4" fill="#1e293b"/>
                                    <text x="100" y="155" text-anchor="middle" font-weight="bold" fill="#fff" font-size="12">Rubin: HBM4</text>
                                </g>
                                <g transform="translate(300, 60)">
                                    <text x="100" y="-10" text-anchor="middle" font-weight="bold" fill="${C.infra}" font-size="16">2. 极致互联</text>
                                    <rect x="0" y="0" width="200" height="60" rx="4" fill="#fffbeb" stroke="${C.infra}" stroke-width="2"/>
                                    <text x="100" y="25" text-anchor="middle" font-weight="bold" fill="${C.infra}" font-size="12">全局显存池</text>
                                    <text x="100" y="45" text-anchor="middle" font-size="11" fill="${C.sub}">Memory Fabric</text>
                                    <path d="M 100 130 L 100 70" stroke="${C.infra}" stroke-width="3"/>
                                    <polygon points="100,60 95,70 105,70" fill="${C.infra}"/>
                                    <rect x="0" y="130" width="200" height="40" rx="4" fill="#1e293b"/>
                                    <text x="100" y="155" text-anchor="middle" font-weight="bold" fill="#fff" font-size="12">NVLink 6</text>
                                </g>
                                <g transform="translate(540, 60)">
                                    <text x="100" y="-10" text-anchor="middle" font-weight="bold" fill="${C.decode}" font-size="16">3. 算力爆发</text>
                                    <rect x="0" y="0" width="200" height="60" rx="4" fill="#ecfdf5" stroke="${C.decode}" stroke-width="2"/>
                                    <text x="100" y="25" text-anchor="middle" font-weight="bold" fill="${C.decode}" font-size="12">System 2 慢思考</text>
                                    <text x="100" y="45" text-anchor="middle" font-size="11" fill="${C.sub}">Speculative Tree</text>
                                    <path d="M 100 130 L 100 70" stroke="${C.decode}" stroke-width="3"/>
                                    <polygon points="100,60 95,70 105,70" fill="${C.decode}"/>
                                    <rect x="0" y="130" width="200" height="40" rx="4" fill="#1e293b"/>
                                    <text x="100" y="155" text-anchor="middle" font-weight="bold" fill="#fff" font-size="12">Native FP4</text>
                                </g>
                            </svg>
                        </div>
                        <div class="details-grid">
                            <div class="card" style="color:${C.prefill}">
                                <div class="card-title">内存墙突破 (HBM4)</div>
                                <div class="card-body">带宽翻倍，配合 <b>Ring Attention</b>，单卡支持 1M+ Context。Agent 可"记住"整本手册。</div>
                            </div>
                            <div class="card" style="color:${C.infra}">
                                <div class="card-title">互联墙突破 (NVLink 6)</div>
                                <div class="card-body">跨卡访问如本地。PD 分离升级为<b>全局显存网络</b>，节点间无感访问 KV Cache。</div>
                            </div>
                            <div class="card" style="color:${C.decode}">
                                <div class="card-title">算力墙突破 (FP4)</div>
                                <div class="card-body">FP4 原生支持。富余算力用于 <b>System 2</b> 推理，通过树状搜索换取高质量智能。</div>
                            </div>
                        </div>
                    </div>`
            }
        ];

        // --- Core Logic ---
        const navList = document.getElementById('navList');
        const slideContainer = document.getElementById('slideContainer');
        const pageNum = document.getElementById('pageNum');
        let currentIndex = 0;

        function initNav() {
            let currentGroup = '';
            navList.innerHTML = slides.map((slide, idx) => {
                let html = '';
                if (slide.group && slide.group !== currentGroup) {
                    currentGroup = slide.group;
                    html += `<div class="nav-group-title">${currentGroup}</div>`;
                }
                
                let iconColor = 'inherit';
                if (slide.color && slide.group !== 'Intro') iconColor = slide.color;

                html += `
                    <div class="nav-item" id="nav-${idx}" onclick="window.nav(${idx})">
                        <div style="width:6px; height:6px; border-radius:50%; background:${iconColor}; opacity:0.7;"></div>
                        ${slide.title}
                    </div>
                `;
                return html;
            }).join('');
        }

        function renderSlide(idx) {
            const slide = slides[idx];
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const activeNav = document.getElementById(`nav-${idx}`);
            if (activeNav) activeNav.classList.add('active');

            if (pageNum) {
                pageNum.innerText = `${idx + 1} / ${slides.length}`;
            }

            let header = '';
            if (slide.group !== 'Intro') {
                header = `
                    <div class="slide-header">
                        <div class="slide-title">
                            <span style="color:${slide.color}"><i class="fa-solid fa-square"></i></span>
                            ${slide.title}
                        </div>
                        <div class="slide-meta">${slide.meta}</div>
                    </div>
                `;
            } else if (slide.id !== 'home') { 
                 header = `
                     <div class="slide-header">
                        <div class="slide-title">${slide.title}</div>
                        <div class="slide-meta">${slide.meta}</div>
                    </div>
                `;
            }

            slideContainer.innerHTML = `${header}${slide.render()}`;
            slideContainer.style.animation = 'none';
            slideContainer.offsetHeight;
            slideContainer.style.animation = 'fadeUp 0.3s ease-out';
        }

        window.nav = function(idx) {
            if (idx >= 0 && idx < slides.length) {
                currentIndex = idx;
                renderSlide(currentIndex);
            }
        };
        
        window.printAllSlides = function() {
            const printContainer = document.getElementById('printContainer');
            printContainer.innerHTML = ''; 
            
            slides.forEach((slide, index) => {
                const pageDiv = document.createElement('div');
                pageDiv.className = 'print-page';
                
                let headerHTML = '';
                if (slide.group !== 'Intro') {
                    headerHTML = `
                        <div class="slide-header">
                            <div class="slide-title" style="color: #0f172a;">
                                <span style="color:${slide.color}"><i class="fa-solid fa-square"></i></span>
                                ${slide.title}
                            </div>
                            <div class="slide-meta" style="color: #475569;">${slide.meta || ''}</div>
                        </div>
                    `;
                } else if(slide.id !== 'home') {
                     headerHTML = `
                         <div class="slide-header">
                            <div class="slide-title" style="color: #0f172a;">${slide.title}</div>
                            <div class="slide-meta" style="color: #475569;">${slide.meta || ''}</div>
                        </div>
                    `;
                }

                pageDiv.innerHTML = headerHTML + slide.render();
                printContainer.appendChild(pageDiv);
            });
            
            window.print();
        };

        initNav();
        window.nav(0);

        window.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowDown' || e.key === 'ArrowRight') window.nav(currentIndex + 1);
            else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') window.nav(currentIndex - 1);
        });

    })();
    </script>
</body>
</html>
