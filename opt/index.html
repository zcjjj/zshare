<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>面向 Agent 应用的长上下文 LLM 部署优化</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* --- 1. 核心视觉定义 (Neon Dark 风格) --- */
        :root {
            --bg-body: #0b0e14;
            --bg-sidebar: #111827;
            --bg-card: #1f2937;
            --bg-glass: rgba(31, 41, 55, 0.7);
            
            --primary: #3b82f6;   /* 科技蓝 */
            --accent: #06b6d4;    /* 亮青色 */
            --highlight: #f59e0b; /* 警示黄 */
            --success: #10b981;   /* 成功绿 */
            --danger: #ef4444;    /* 警告红 */
            
            --text-main: #f3f4f6;
            --text-sub: #9ca3af;
            --border: #374151;
            
            --shadow-card: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            --shadow-neon: 0 0 10px rgba(59, 130, 246, 0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- 侧边栏 --- */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 20;
        }

        .brand {
            padding: 24px;
            font-size: 1.1rem;
            font-weight: 800;
            color: var(--text-main);
            border-bottom: 1px solid var(--border);
            letter-spacing: 1px;
            background: linear-gradient(90deg, rgba(59,130,246,0.15) 0%, transparent 100%);
            display: flex; align-items: center; gap: 10px;
        }
        .brand i { color: var(--primary); }

        .nav-items { flex: 1; overflow-y: auto; padding: 15px 0; }
        .nav-items::-webkit-scrollbar { width: 4px; }
        .nav-items::-webkit-scrollbar-thumb { background: #374151; border-radius: 2px; }

        .nav-group {
            padding: 12px 24px 6px;
            font-size: 0.7rem;
            text-transform: uppercase;
            color: #6b7280;
            font-weight: 700;
            letter-spacing: 0.05em;
            margin-top: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 10px 24px;
            color: var(--text-sub);
            text-decoration: none;
            font-size: 0.9rem;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        .nav-link:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-link.active {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.15) 0%, transparent 100%);
            color: var(--primary);
            border-left-color: var(--primary);
        }

        /* --- 主内容区 --- */
        .main {
            flex: 1;
            overflow-y: auto;
            padding: 40px 60px;
            scroll-behavior: smooth;
            position: relative;
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #0b0e14 60%);
        }

        .slide {
            min-height: 85vh;
            margin-bottom: 60px;
            background: var(--bg-glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 50px;
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
            position: relative;
            page-break-after: always;
        }

        .slide-header {
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .slide-title h2 { 
            font-size: 2.2rem; 
            margin-bottom: 8px; 
            background: linear-gradient(to right, #fff, #94a3b8); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent; 
            font-weight: 700;
        }
        .slide-title p { color: var(--primary); font-size: 1rem; font-weight: 500; letter-spacing: 0.5px; }
        .slide-number { font-family: 'Courier New', monospace; color: #4b5563; font-weight: bold; font-size: 1.5rem; opacity: 0.5; }

        /* --- 布局与排版 --- */
        .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; flex: 1; }
        .full-width { grid-column: 1 / -1; }
        
        .text-block p { margin-bottom: 12px; line-height: 1.7; font-size: 1.05rem; color: #d1d5db; }
        .text-block ul { padding-left: 20px; margin-bottom: 20px; color: #d1d5db; }
        .text-block li { margin-bottom: 10px; }
        .highlight { color: var(--highlight); font-weight: 600; }
        .accent-text { color: var(--accent); font-weight: 600; }

        /* --- 通用组件 --- */
        .chart-box {
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }

        .tag { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; margin-right: 6px; margin-bottom: 6px; }
        .tag-blue { background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.3); }
        .tag-orange { background: rgba(245,158,11,0.15); color: #fbbf24; border: 1px solid rgba(245,158,11,0.3); }
        .tag-green { background: rgba(16,185,129,0.15); color: #34d399; border: 1px solid rgba(16,185,129,0.3); }
        .tag-red { background: rgba(239,68,68,0.15); color: #f87171; border: 1px solid rgba(239,68,68,0.3); }

        .stat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; width: 100%; }
        .stat-card { background: rgba(255,255,255,0.03); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid var(--border); transition: transform 0.2s; }
        .stat-card:hover { transform: translateY(-2px); background: rgba(255,255,255,0.05); }
        .stat-value { font-size: 2.2rem; font-weight: 800; color: #fff; margin: 10px 0; }
        .stat-label { font-size: 0.85rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.05em; }

        /* --- 架构金字塔 (Pyramid) --- */
        .pyramid-container { display: flex; flex-direction: column; align-items: center; width: 100%; gap: 12px; padding: 10px 0; }
        .p-level {
            width: 100%; padding: 18px 25px; color: #fff; border-radius: 8px; position: relative;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; align-items: center;
            backdrop-filter: blur(4px);
            transition: all 0.3s;
        }
        .p-level:hover { transform: scale(1.02); box-shadow: var(--shadow-neon); z-index: 10; }
        .l4 { width: 50%; background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%); }
        .l3 { width: 65%; background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); }
        .l2 { width: 80%; background: linear-gradient(135deg, #0891b2 0%, #155e75 100%); }
        .p-content { display: flex; align-items: center; gap: 15px; width: 100%; }
        .p-icon { font-size: 1.4rem; width: 40px; display: flex; justify-content: center; opacity: 0.9; }
        .p-text h4 { margin: 0; font-size: 1.1rem; text-transform: uppercase; font-weight: 700; margin-bottom: 4px; }
        .p-text span { font-size: 0.85rem; opacity: 0.8; }

        /* --- 示意图 (Diagrams) --- */
        .node-model { border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; z-index: 2; }
        .node-m-large { background: var(--primary); color: white; border: 2px solid #2563eb; }
        .node-m-small { background: var(--accent); color: black; border: 2px solid #0891b2; }
        .node-token { border-radius: 50%; background: #334155; display: flex; align-items: center; justify-content: center; font-family: monospace; font-size: 0.8rem; border: 1px solid #475569; width: 28px; height: 28px;}
        .token-drafted { border-color: var(--accent); color: var(--accent); background: rgba(6,182,212,0.1); border-style: dashed; }
        .token-verified { background: var(--success); color: white; border-color: var(--success); }
        .block-verify { border: 2px dashed var(--primary); border-radius: 8px; background: rgba(59,130,246,0.1); display: flex; gap: 8px; align-items: center; }
        .node { background: #1f2937; border: 1px solid var(--border); padding: 15px; border-radius: 8px; text-align: center; min-width: 100px; }

        /* PDF 按钮 */
        #pdf-btn {
            position: fixed; bottom: 30px; right: 30px;
            background: linear-gradient(135deg, var(--primary), #2563eb);
            color: #fff; border: none; padding: 12px 20px; border-radius: 30px;
            font-weight: 600; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            cursor: pointer; z-index: 100; transition: transform 0.2s;
            display: flex; align-items: center; gap: 8px;
        }
        #pdf-btn:hover { transform: scale(1.05); }

        /* Checklist 样式 */
        .checklist-item {
            display: flex; align-items: center; gap: 15px; padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .checklist-item:last-child { border-bottom: none; }
        .check-icon { color: var(--success); font-size: 1.2rem; }
        .check-text { font-size: 1rem; color: var(--text-main); }

        /* Matrix Table */
        .matrix-table { width: 100%; border-collapse: separate; border-spacing: 4px; font-size: 0.75rem; }
        .matrix-table th { color: #9ca3af; padding: 5px; font-weight: 600; }
        .cell { padding: 6px; border-radius: 4px; text-align: center; font-weight: 600; }
        .c-pre { background: rgba(55,65,81,0.5); color: #9ca3af; }
        .c-draft { background: rgba(245,158,11,0.2); color: #fbbf24; }
        .c-pad { background: transparent; border: 1px dashed #374151; color: #4b5563; }

        /* 打印适配 */
        @media print {
            .sidebar, #pdf-btn { display: none !important; }
            body { height: auto; overflow: visible; background: #0b0e14; }
            .main { padding: 0; width: 100%; }
            .slide { margin-bottom: 0; border: none; box-shadow: none; break-after: always; min-height: 100vh; background: #0b0e14; }
        }
    </style>
</head>
<body>

<nav class="sidebar">
    <div class="brand">
        <i class="fa-solid fa-brain"></i> <span>AGENT.INFRA</span>
    </div>
    <div class="nav-items" id="navItems">
        <!-- JS 动态生成 -->
    </div>
</nav>

<main class="main" id="mainContent">
    <!-- JS 动态生成 -->
</main>

<button id="pdf-btn" onclick="generatePDF()">
    <i class="fa-solid fa-file-pdf"></i> Export PDF
</button>

<script>
const slides = [
    // --- Slide 1: 封面 ---
    {
        group: "1. 背景与架构",
        title: "面向 Agent 应用的长上下文 LLM 部署优化",
        subtitle: "突破显存墙：支撑 1M+ Context 的算力新基建",
        content: `
            <div class="content-grid" style="align-items: center;">
                <div class="text-block">
                    <h3 style="font-size:1.5rem; color:var(--text-main); margin-bottom:20px;">背景与目标</h3>
                    <ul style="font-size: 1.1rem;">
                        <li><strong>长输入挑战:</strong> Agent 场景输入常超 128k 甚至 1M tokens，导致 KV-Cache 显存爆炸。</li>
                        <li><strong>双重敏感:</strong> 既要求极低的 <strong>首字延迟 (TTFT)</strong>，又要求流畅的 <strong>解码速度 (TPOT)</strong>。</li>
                        <li><strong>核心目标:</strong> 高吞吐、低延迟、低成本、可横向扩展。</li>
                    </ul>
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border);">
                        <div style="display:flex; gap:10px;">
                            <span class="tag tag-blue">PD Separation</span>
                            <span class="tag tag-green">KV Offloading</span>
                            <span class="tag tag-orange">Speculative Decoding</span>
                        </div>
                    </div>
                </div>
                <div class="chart-box" style="height: 300px; border:none; background:transparent;">
                    <div style="position:relative; width:220px; height:220px; display:flex; align-items:center; justify-content:center;">
                        <div style="position:absolute; width:100%; height:100%; border:4px dashed var(--primary); border-radius:50%; animation: spin 20s linear infinite;"></div>
                        <div style="position:absolute; width:80%; height:80%; border:2px solid var(--accent); border-radius:50%; opacity:0.5;"></div>
                        <div style="text-align:center;">
                            <div style="font-size:3rem; font-weight:800; color:var(--text-main);">1M+</div>
                            <div style="font-size:1.2rem; color:var(--text-sub);">Context</div>
                        </div>
                    </div>
                </div>
            </div>
        `
    },

    // --- Slide 2: 优化金字塔 ---
    {
        title: "优化金字塔",
        subtitle: "L2-L4 分层优化策略",
        content: `
            <div class="content-grid">
                <div class="pyramid-container" style="justify-content: center;">
                    <!-- L4 -->
                    <div class="p-level l4">
                        <div class="p-content">
                            <div class="p-icon"><i class="fa-solid fa-sitemap"></i></div>
                            <div class="p-text">
                                <h4>L4 调度层 (Schedule)</h4>
                                <span>PD 分离 | 语义路由 | 弹性扩缩</span>
                            </div>
                        </div>
                    </div>
                    <!-- L3 -->
                    <div class="p-level l3">
                        <div class="p-content">
                            <div class="p-icon"><i class="fa-solid fa-memory"></i></div>
                            <div class="p-text">
                                <h4>L3 存储层 (Storage)</h4>
                                <span>KV-Cache 压缩 | 分级存储 | Prefix 复用</span>
                            </div>
                        </div>
                    </div>
                    <!-- L2 -->
                    <div class="p-level l2">
                        <div class="p-content">
                            <div class="p-icon"><i class="fa-solid fa-microchip"></i></div>
                            <div class="p-text">
                                <h4>L2 计算层 (Compute)</h4>
                                <span>稀疏 Attention | 投机解码 | 量化</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-block">
                    <h3 style="color:var(--text-main); margin-bottom:20px;">分层解耦，逐个击破</h3>
                    <ul>
                        <li style="margin-bottom:15px;">
                            <strong class="highlight">L4 调度层:</strong> 解决集群资源分配问题。通过 <strong>PD 分离</strong> 将计算密集型（Prefill）和显存密集型（Decode）任务物理隔离。
                        </li>
                        <li style="margin-bottom:15px;">
                            <strong class="highlight">L3 存储层:</strong> 解决显存墙问题。利用 <strong>Offloading</strong> 和 <strong>压缩技术</strong> 在有限显存下塞入更多 Context。
                        </li>
                        <li style="margin-bottom:15px;">
                            <strong class="highlight">L2 计算层:</strong> 解决计算瓶颈。利用 <strong>投机采样</strong> 和 <strong>FlashAttention</strong> 提升单卡算力利用率。
                        </li>
                    </ul>
                </div>
            </div>
        `
    },

    // --- Slide 3 (L4-1): PD 分离 ---
    {
        group: "2. L4 调度层",
        title: "L4 调度 (1/2): 分离式推理 (PD Separation)",
        subtitle: "Prefill 与 Decode 的物理隔离架构",
        content: `
            <div class="full-width">
                <!-- 架构图 -->
                <div class="chart-box" style="margin-bottom: 25px; padding: 15px; background: rgba(255,255,255,0.01);">
                    <svg width="100%" height="220" viewBox="0 0 800 320">
                        <defs><marker id="ah" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0, 10 3.5, 0 7" fill="#6b7280"/></marker></defs>
                        
                        <!-- Blocks -->
                        <rect x="50" y="50" width="180" height="100" rx="8" fill="rgba(245,158,11,0.1)" stroke="#f59e0b" stroke-width="2"/>
                        <text x="140" y="90" fill="#f59e0b" text-anchor="middle" font-weight="bold">Prefill Cluster</text>
                        <text x="140" y="115" fill="#9ca3af" text-anchor="middle" font-size="12">High Compute (H800)</text>

                        <rect x="570" y="50" width="180" height="100" rx="8" fill="rgba(59,130,246,0.1)" stroke="#3b82f6" stroke-width="2"/>
                        <text x="660" y="90" fill="#3b82f6" text-anchor="middle" font-weight="bold">Decode Cluster</text>
                        <text x="660" y="115" fill="#9ca3af" text-anchor="middle" font-size="12">High BW (L40S)</text>

                        <rect x="280" y="80" width="240" height="40" rx="20" fill="rgba(16,185,129,0.1)" stroke="#10b981" stroke-dasharray="4"/>
                        <text x="400" y="105" fill="#10b981" text-anchor="middle" font-size="14" font-weight="bold">KV Cache Transfer</text>

                        <rect x="250" y="240" width="300" height="50" rx="8" fill="#1f2937" stroke="#4b5563"/>
                        <text x="400" y="270" fill="#e5e7eb" text-anchor="middle" font-weight="bold">Unified Scheduler</text>

                        <!-- Arrows -->
                        <line x1="230" y1="100" x2="280" y2="100" stroke="#6b7280" stroke-width="2" marker-end="url(#ah)"/>
                        <line x1="520" y1="100" x2="570" y2="100" stroke="#6b7280" stroke-width="2" marker-end="url(#ah)"/>
                        <path d="M300 240 L140 150" stroke="#6b7280" stroke-width="2" marker-end="url(#ah)" fill="none"/>
                        <path d="M500 240 L660 150" stroke="#6b7280" stroke-width="2" marker-end="url(#ah)" fill="none" stroke-dasharray="4"/>
                    </svg>
                </div>

                <!-- 详情矩阵 (2x2) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                        <h4 style="color:var(--text-main); margin-bottom:10px;"><i class="fa-solid fa-thumbs-up text-green"></i> 核心价值</h4>
                        <ul style="font-size:0.85rem; padding-left:15px; color:var(--text-sub);">
                            <li><strong>消除干扰:</strong> 避免 Prefill 阶段抢占计算资源导致 Decode 卡顿。</li>
                            <li><strong>硬件特化:</strong> Prefill 用算力卡(H800)，Decode 用显存卡(L40S)，降低 TCO。</li>
                        </ul>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                        <h4 style="color:var(--text-main); margin-bottom:10px;"><i class="fa-solid fa-microchip text-blue"></i> 关键技术</h4>
                        <ul style="font-size:0.85rem; padding-left:15px; color:var(--text-sub);">
                            <li><strong>RDMA Zero-copy:</strong> 绕过 CPU 直接传输 KV Cache，降低延迟。</li>
                            <li><strong>Chunked Prefill:</strong> 长 Prompt 切片流水线处理，掩盖传输时间。</li>
                        </ul>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                        <h4 style="color:var(--text-main); margin-bottom:10px;"><i class="fa-solid fa-calculator text-highlight"></i> 实例配比计算</h4>
                        <ul style="font-size:0.85rem; padding-left:15px; color:var(--text-sub);">
                            <li><strong>输入/输出比:</strong> Ratio = $L_{in} / L_{out}$，比值越高需越多 Prefill 节点。</li>
                            <li><strong>SLA 约束:</strong> TTFT 要求越严，Prefill 冗余度需越高。</li>
                        </ul>
                    </div>
                    <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; border: 1px solid var(--border);">
                        <h4 style="color:var(--text-main); margin-bottom:10px;"><i class="fa-solid fa-bullseye text-accent"></i> 适用场景</h4>
                        <div style="display:flex; gap:8px; flex-wrap:wrap;">
                            <span class="tag tag-blue">长文档 RAG</span>
                            <span class="tag tag-orange">混合长短负载</span>
                            <span class="tag tag-green">高并发集群</span>
                        </div>
                    </div>
                </div>
            </div>
        `
    },

    // --- Slide 4 (L4-2): 语义路由 ---
    {
        title: "L4 调度 (2/2): 语义路由与前缀复用",
        subtitle: "基于 Cache Affinity 的智能路由",
        content: `
            <div class="content-grid">
                <div class="text-block">
                    <p>利用 <strong>Consistent Hashing</strong> 或 <strong>Radix Routing</strong> 将具有相同 Prompt 前缀（如 System Prompt、热门文档）的请求路由到同一节点。</p>
                    <div class="stat-grid" style="margin-top:40px;">
                        <div class="stat-card">
                            <div class="stat-value text-green">95%</div>
                            <div class="stat-label">Cache Hit Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-blue">3x</div>
                            <div class="stat-label">Prefill Speedup</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-highlight">-60%</div>
                            <div class="stat-label">Memory Waste</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value text-accent">0</div>
                            <div class="stat-label">Prefill Time (on Hit)</div>
                        </div>
                    </div>
                </div>
                <div class="chart-box">
                    <div style="display:flex; flex-direction:column; align-items:center; gap:20px; width:100%;">
                        <div style="display:flex; gap:10px;">
                            <div class="node" style="border-color:var(--text-sub);">Req 1: [Doc A] + Q1</div>
                            <div class="node" style="border-color:var(--text-sub);">Req 2: [Doc A] + Q2</div>
                        </div>
                        <i class="fa-solid fa-arrow-down" style="color:var(--accent);"></i>
                        <div class="node" style="border-color:var(--accent); width:200px;">
                            <strong>Smart Router</strong>
                            <span>Prefix Matcher</span>
                        </div>
                        <div style="display:flex; gap:40px; width:100%; justify-content:center;">
                            <div style="flex:1; border:1px solid var(--success); padding:15px; border-radius:8px; background:rgba(16,185,129,0.05); text-align:center;">
                                <strong style="color:var(--success);">Worker 01</strong><br>
                                <span style="font-size:0.8rem;">Cached: [Doc A]</span>
                                <div style="margin-top:10px; font-size:0.75rem; color:var(--success);">Hit! Zero Prefill</div>
                            </div>
                            <div style="flex:1; border:1px solid var(--border); padding:15px; border-radius:8px; opacity:0.5; text-align:center;">
                                <strong>Worker 02</strong><br>
                                <span style="font-size:0.8rem;">Cached: [Doc B]</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `
    },

    // --- Slide 5 (L3-1): 分级存储 ---
    {
        group: "3. L3 存储层",
        title: "L3 存储 (1/2): 分级存储与 Offloading",
        subtitle: "利用分级存储打破显存墙",
        content: `
            <div class="content-grid">
                <div class="text-block">
                    <p>当 Context 长度突破显存极限（如 128k+），单纯依赖 HBM 成本过高。<strong>Offloading</strong> 技术利用 PCIe 带宽，将非活跃 KV Cache 下沉至 CPU RAM 或 NVMe SSD。</p>
                    
                    <div style="margin-top:20px; background:rgba(255,255,255,0.03); padding:20px; border-radius:8px; border:1px solid var(--border);">
                        <h4 style="color:var(--text-main); margin-bottom:10px; font-size:1rem;">关键机制</h4>
                        <ul style="font-size:0.9rem; padding-left:20px; color:var(--text-sub);">
                            <li style="margin-bottom:8px;"><strong>Tiered Storage:</strong> 建立 HBM (Hot) -> DRAM (Warm) -> SSD (Cold) 的三级存储金字塔。</li>
                            <li style="margin-bottom:8px;"><strong>Prefetching:</strong> 基于 Attention pattern 预测，在计算前异步将数据从 CPU 拉回 GPU，掩盖 PCIe 延迟。</li>
                            <li><strong>Non-blocking:</strong> 计算与数据传输 (H2D/D2H) 并行流水线。</li>
                        </ul>
                    </div>
                </div>

                <!-- 架构示意图 -->
                <div class="chart-box" style="flex-direction: column; gap: 10px; padding: 30px; background: rgba(0,0,0,0.2);">
                    
                    <!-- GPU HBM -->
                    <div style="width:100%; display:flex; align-items:center; gap:15px;">
                        <div style="width:80px; text-align:right; font-weight:800; color:#ef4444; font-size:0.9rem;">GPU HBM</div>
                        <div style="flex:1; height:50px; border:2px solid #ef4444; background:rgba(239,68,68,0.1); border-radius:8px; display:flex; align-items:center; justify-content:center; gap:5px; position:relative;">
                            <span class="tag tag-red" style="background:#ef4444; color:#fff; border:none;">Hot</span>
                            <span style="font-size:0.8rem; color:#fff;">Active Tokens</span>
                            <div style="position:absolute; right:10px; font-size:0.7rem; color:#ef4444;">80GB/Card</div>
                        </div>
                    </div>

                    <!-- PCIe Bus -->
                    <div style="display:flex; align-items:center; gap:10px; color:#6b7280; font-size:0.8rem; height:40px;">
                        <div style="width:80px;"></div>
                        <div style="flex:1; display:flex; justify-content:center; align-items:center; gap:20px; border-left:2px dashed #4b5563; border-right:2px dashed #4b5563; height:100%;">
                            <span><i class="fa-solid fa-arrow-up"></i> Swap In</span>
                            <span style="border:1px solid #4b5563; padding:2px 8px; border-radius:4px;">PCIe Gen5 (128GB/s)</span>
                            <span><i class="fa-solid fa-arrow-down"></i> Swap Out</span>
                        </div>
                    </div>

                    <!-- CPU DRAM -->
                    <div style="width:100%; display:flex; align-items:center; gap:15px;">
                        <div style="width:80px; text-align:right; font-weight:800; color:#f59e0b; font-size:0.9rem;">CPU RAM</div>
                        <div style="flex:1; height:50px; border:2px solid #f59e0b; background:rgba(245,158,11,0.1); border-radius:8px; display:flex; align-items:center; justify-content:center; gap:5px; position:relative;">
                            <span class="tag tag-orange" style="background:#f59e0b; color:#000; border:none;">Warm</span>
                            <span style="font-size:0.8rem; color:#e5e7eb;">Cached Blocks</span>
                            <div style="position:absolute; right:10px; font-size:0.7rem; color:#f59e0b;">1TB+</div>
                        </div>
                    </div>

                    <!-- NVMe SSD (Optional) -->
                    <div style="width:100%; margin-top:10px; display:flex; align-items:center; gap:15px; opacity:0.6;">
                        <div style="width:80px; text-align:right; font-weight:700; color:#3b82f6; font-size:0.8rem;">NVMe SSD</div>
                        <div style="flex:1; height:40px; border:1px dashed #3b82f6; border-radius:8px; display:flex; align-items:center; justify-content:center;">
                            <span style="font-size:0.75rem;">Cold Data (Infinite)</span>
                        </div>
                    </div>

                </div>
            </div>
        `
    },

    // --- Slide 6 (L3-2): KV 压缩 ---
    {
        title: "L3 存储 (2/2): KV-Cache 极致压缩",
        subtitle: "量化、剪枝与稀疏化",
        content: `
            <div class="content-grid">
                <div class="text-block">
                    <h3 style="color:var(--text-main); margin-bottom:20px;">全生命周期的压缩策略</h3>
                    <ul>
                        <li style="margin-bottom:15px;">
                            <strong class="highlight">1. 写入前 (Pre-write):</strong>
                            利用 <strong>INT4/W4A8 量化</strong> 减少显存占用。研究表明，KV Cache 对精度不敏感，4-bit 量化仅带来 <1% 的 PPL 损失。
                        </li>
                        <li style="margin-bottom:15px;">
                            <strong class="highlight">2. 维护中 (Runtime):</strong>
                            <strong>Token Pruning (H2O):</strong> 动态丢弃注意力分数低的 Token（如生僻词、无意义介词），仅保留 Heavy Hitters。
                        </li>
                        <li style="margin-bottom:15px;">
                            <strong class="highlight">3. 计算时 (On-the-fly):</strong>
                            <strong>Dynamic Sparsity (MInference):</strong> 在 Attention 计算时只计算 Top-K 相关的 Head，跳过无关计算。
                        </li>
                    </ul>
                </div>
                <div class="chart-box" style="flex-direction: column; gap: 20px;">
                    <div style="text-align:center; margin-bottom:10px; color:var(--text-sub);">Memory Usage per Token</div>
                    
                    <div class="waterfall-row" style="width:100%;">
                        <div class="wf-label">FP16 (Baseline)</div>
                        <div class="wf-bar" style="width: 100%; background: #4b5563;">100% (2B/token)</div>
                    </div>
                    <div class="waterfall-row" style="width:100%;">
                        <div class="wf-label">INT8 Quant</div>
                        <div class="wf-bar" style="width: 50%; background: var(--primary);">50% (1B/token)</div>
                    </div>
                    <div class="waterfall-row" style="width:100%;">
                        <div class="wf-label">INT4 + Pruning</div>
                        <div class="wf-bar" style="width: 25%; background: var(--success);">25% (0.5B/token)</div>
                    </div>
                    
                    <div style="margin-top:20px; padding:15px; border:1px solid var(--accent); border-radius:8px; color:var(--accent);">
                        <strong>Result:</strong> 128k Context @ RTX 4090 (24GB)
                    </div>
                </div>
            </div>
        `
    },

    // --- Slide 7 (L2-1): 投机采样 ---
    {
        group: "4. L2 计算层",
        title: "L2 计算 (1/2): 投机采样原理",
        subtitle: "Draft -> Verify: 用算力换带宽",
        content: `
            <div class="content-grid" style="grid-template-columns: 1fr; gap:20px;">
                <!-- 原理图 -->
                <div style="display:flex; gap:20px; align-items:stretch;">
                    <div style="flex:1; background:rgba(255,255,255,0.02); padding:15px; border-radius:8px; border:1px dashed var(--border);">
                        <div style="font-size:0.8rem; color:var(--text-sub); margin-bottom:10px;">传统模式 (Standard)</div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span class="tag tag-blue">LLM</span> <i class="fa-solid fa-arrow-right arrow-r" style="font-size:0.8rem;"></i>
                            <span class="node-token" style="font-size:0.7rem;">A</span> <i class="fa-solid fa-arrow-right arrow-r" style="font-size:0.8rem;"></i>
                            <span class="tag tag-blue">LLM</span> <i class="fa-solid fa-arrow-right arrow-r" style="font-size:0.8rem;"></i>
                            <span class="node-token" style="font-size:0.7rem;">B</span>
                        </div>
                        <p style="font-size:0.75rem; color:var(--text-sub); margin-top:10px;">串行生成，内存带宽受限 (Memory Bound)</p>
                    </div>
                    <div style="flex:1.2; background:rgba(16,185,129,0.05); padding:15px; border-radius:8px; border:1px solid var(--success);">
                        <div style="font-size:0.8rem; color:var(--success); margin-bottom:10px; font-weight:bold;">投机模式 (Speculative)</div>
                        <div style="margin-bottom:8px; display:flex; align-items:center; gap:5px;">
                            <span style="font-size:0.75rem; width:50px;">Draft:</span>
                            <span class="tag tag-orange">Small</span> <i class="fa-solid fa-arrow-right arrow-r" style="font-size:0.8rem;"></i>
                            <span class="token tk-draft">a</span> <span class="token tk-draft">b</span> <span class="token tk-draft">c</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span style="font-size:0.75rem; width:50px;">Verify:</span>
                            <span class="tag tag-blue">Large</span> <i class="fa-solid fa-arrow-right arrow-r" style="font-size:0.8rem;"></i>
                            <div style="border:1px dashed var(--primary); padding:3px; border-radius:4px; display:flex; gap:3px;">
                                <span class="token tk-verify">A</span> <span class="token tk-verify">B</span> <span class="token tk-verify">C</span>
                            </div>
                        </div>
                        <p style="font-size:0.75rem; color:var(--success); margin-top:10px;">并行验证，2x-3x 加速</p>
                    </div>
                </div>

                <!-- 批量验证实例 -->
                <div style="display:grid; grid-template-columns: 1fr 1.5fr; gap:20px;">
                    <div>
                        <h4 style="font-size:0.9rem; color:var(--text-main); margin-bottom:10px;">Draft Candidates (γ=6)</h4>
                        <div class="chart-box" style="display:block; padding:10px; text-align:left;">
                            <div style="font-size:0.75rem; color:var(--text-sub); margin-bottom:5px;">Prefix: "The cat is on the"</div>
                            <div style="display:flex; flex-direction:column; gap:4px; font-family:monospace; font-size:0.8rem;">
                                <div>1. <span class="tk-draft">mat .</span></div>
                                <div>2. <span class="tk-draft">sofa quietly .</span></div>
                                <div>3. <span class="tk-draft">floor and sleeps .</span></div>
                                <div>... (Padding to Max Len)</div>
                            </div>
                        </div>
                    </div>
                    <div>
                        <h4 style="font-size:0.9rem; color:var(--text-main); margin-bottom:10px;">Batch Verification Tensor</h4>
                        <div class="chart-box" style="padding:10px; overflow-x:auto; display:block;">
                            <table class="matrix-table">
                                <thead>
                                    <tr><th>ID</th><th colspan="3" class="c-pre">Shared Prefix (Cached)</th><th colspan="3" class="c-draft">Draft Tokens</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>1</td><td class="c-pre">...</td><td class="c-pre">on</td><td class="c-pre">the</td><td class="c-draft">mat</td><td class="c-draft">.</td><td class="c-pad">[P]</td></tr>
                                    <tr><td>2</td><td class="c-pre">...</td><td class="c-pre">on</td><td class="c-pre">the</td><td class="c-draft">sofa</td><td class="c-draft">quiet</td><td class="c-draft">.</td></tr>
                                    <tr><td>3</td><td class="c-pre">...</td><td class="c-pre">on</td><td class="c-pre">the</td><td class="c-draft">floor</td><td class="c-draft">and</td><td class="c-draft">...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        `
    },

    // --- Slide 8 (L2-2): 算子优化 ---
    {
        title: "L2 计算 (2/2): 算子级加速",
        subtitle: "FlashAttention 与线性注意力",
        content: `
            <div class="content-grid">
                <div class="text-block">
                    <h3 style="color:var(--text-main); margin-bottom:20px;">打破 O(N²) 的魔咒</h3>
                    <ul>
                        <li style="margin-bottom:20px;">
                            <strong class="highlight">FlashAttention-V3/V4:</strong> 
                            利用 GPU SRAM 进行 IO 感知的分块计算。V3 针对 Hopper 架构优化，利用 TMA (Tensor Memory Accelerator) 实现异步数据拷贝。
                        </li>
                        <li style="margin-bottom:20px;">
                            <strong class="highlight">Linear Attention:</strong> 
                            通过 Kernel Trick 将注意力机制的复杂度从平方级降低到线性 O(N)。适合超长序列的初筛。
                        </li>
                        <li style="margin-bottom:20px;">
                            <strong class="highlight">FP8 精度:</strong> 
                            在 H100/H800 上启用 FP8 Tensor Core，吞吐量相比 BF16 提升 2 倍。
                        </li>
                    </ul>
                </div>
                <div class="chart-box" style="flex-direction: column; gap: 20px;">
                    <div style="font-size:1.2rem; font-weight:bold; color:var(--text-main);">Attention 复杂度对比</div>
                    <div style="width:100%; display:flex; align-items:flex-end; height:150px; gap:20px; padding-bottom:10px; border-bottom:2px solid var(--border);">
                        <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                            <div style="width:40px; height:120px; background:var(--danger); border-radius:4px;"></div>
                            <span style="margin-top:10px; font-size:0.8rem;">Standard Attention<br>O(N²)</span>
                        </div>
                        <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                            <div style="width:40px; height:40px; background:var(--primary); border-radius:4px;"></div>
                            <span style="margin-top:10px; font-size:0.8rem;">FlashAttention<br>O(N²) (Fast IO)</span>
                        </div>
                        <div style="flex:1; display:flex; flex-direction:column; align-items:center;">
                            <div style="width:40px; height:10px; background:var(--success); border-radius:4px;"></div>
                            <span style="margin-top:10px; font-size:0.8rem;">Linear Attention<br>O(N)</span>
                        </div>
                    </div>
                </div>
            </div>
        `
    },

    // --- Slide 9: 落地与 KPI ---
    {
        group: "5. 落地实战",
        title: "落地效果与 KPI",
        subtitle: "1M Token 场景实战数据",
        content: `
            <div class="content-grid">
                <div class="text-block">
                    <h3 style="color:var(--text-main); margin-bottom:20px;">端到端收益</h3>
                    <div class="stat-grid" style="grid-template-columns: 1fr 1fr; gap:20px;">
                        <div class="stat-card">
                            <div class="stat-value" style="color:var(--accent);">3s</div>
                            <div class="stat-label">TTFT (原 20s) <span style="color:var(--success); font-size:0.7rem;">↓85%</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color:var(--primary);">24G</div>
                            <div class="stat-label">单卡显存 (原 80G) <span style="color:var(--success); font-size:0.7rem;">↓70%</span></div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color:var(--success);">+220%</div>
                            <div class="stat-label">集群吞吐量</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" style="color:var(--highlight);">-60%</div>
                            <div class="stat-label">TCO (总成本)</div>
                        </div>
                    </div>
                </div>
                
                <div style="background:rgba(255,255,255,0.03); padding:30px; border-radius:12px; border:1px solid var(--border);">
                    <h3 style="color:var(--text-main); margin-bottom:20px;"><i class="fa-solid fa-clipboard-check text-green"></i> 生产 Checklist</h3>
                    <div class="checklist-item">
                        <i class="fa-solid fa-check check-icon"></i>
                        <span class="check-text">PD 实例配比自动调优 (Auto-Scaling)</span>
                    </div>
                    <div class="checklist-item">
                        <i class="fa-solid fa-check check-icon"></i>
                        <span class="check-text">语义路由灰度发布策略</span>
                    </div>
                    <div class="checklist-item">
                        <i class="fa-solid fa-check check-icon"></i>
                        <span class="check-text">分级缓存命中率监控与告警</span>
                    </div>
                    <div class="checklist-item">
                        <i class="fa-solid fa-check check-icon"></i>
                        <span class="check-text">量化模型精度回归测试 (PPL/Score)</span>
                    </div>
                    <div class="checklist-item">
                        <i class="fa-solid fa-check check-icon"></i>
                        <span class="check-text">24小时长稳定性压测 (Memory Leak)</span>
                    </div>
                </div>
            </div>
            <div class="center" style="margin-top:30px; font-size:1.1rem; color:var(--text-sub); text-align:center;">
                - Thanks & QA -
            </div>
        `
    }
];

// --- 初始化逻辑 ---
const navItems = document.getElementById('navItems');
const mainContent = document.getElementById('mainContent');
let currentGroup = '';

// 生成动画 CSS
const styleSheet = document.createElement("style");
styleSheet.innerText = `
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .text-green { color: var(--success); }
    .text-blue { color: var(--primary); }
    .text-highlight { color: var(--highlight); }
    .text-accent { color: var(--accent); }
`;
document.head.appendChild(styleSheet);

slides.forEach((slide, index) => {
    // 导航分组
    if (slide.group && slide.group !== currentGroup) {
        currentGroup = slide.group;
        const groupTitle = document.createElement('div');
        groupTitle.className = 'nav-group';
        groupTitle.textContent = slide.group;
        navItems.appendChild(groupTitle);
    }

    // 导航链接
    const navLink = document.createElement('a');
    navLink.href = `#slide-${index}`;
    navLink.className = 'nav-link';
    navLink.innerHTML = `<i class="fa-solid fa-circle" style="font-size:6px; margin-right:10px; opacity:0.5;"></i> ${slide.title}`;
    navItems.appendChild(navLink);

    // 幻灯片内容
    const slideEl = document.createElement('section');
    slideEl.className = 'slide';
    slideEl.id = `slide-${index}`;
    slideEl.innerHTML = `
        <div class="slide-header">
            <div class="slide-title">
                <h2>${slide.title}</h2>
                <p>${slide.subtitle || ''}</p>
            </div>
            <div class="slide-number">${String(index + 1).padStart(2, '0')}</div>
        </div>
        ${slide.content}
    `;
    mainContent.appendChild(slideEl);
});

// 滚动监听
const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            const id = entry.target.id;
            const activeLink = document.querySelector(`a[href="#${id}"]`);
            if (activeLink) {
                activeLink.classList.add('active');
                activeLink.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });
}, { threshold: 0.3 });

document.querySelectorAll('.slide').forEach(slide => observer.observe(slide));

// PDF 导出
function generatePDF() {
    const element = document.getElementById('mainContent');
    const btn = document.getElementById('pdf-btn');
    
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Processing...';
    btn.disabled = true;
    btn.style.opacity = '0'; // 截图时隐藏按钮

    const opt = {
        margin: 0,
        filename: 'Agent_Long_Context_Optimization.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, backgroundColor: '#0b0e14' },
        jsPDF: { unit: 'px', format: [1200, 800], orientation: 'landscape' }, // 这里的尺寸对应宽屏 PPT
        pagebreak: { mode: ['css', 'legacy'] }
    };

    html2pdf().set(opt).from(element).save().then(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        btn.style.opacity = '1';
    });
}
</script>
</body>
</html>
